<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>HD SAISON: Xử Lý Hợp Đồng & Tạo QR Thanh Toán</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Meta tags for social sharing -->
  <meta property="og:title" content="HD SAISON: VietQR, In Hợp Đồng & Tính Toán Khoản Vay" />
  <meta property="og:description" content="Tạo mã VietQR thanh toán, Tự động tách và in bộ hợp đồng, Công cụ tính khoản vay trả góp (ED) tiện lợi" />
  <meta property="og:image" content="https://i.ibb.co/Pvx3mZ44/images.png" />
  <meta property="og:type" content="website" />

  <link rel="icon" type="image/png" href="https://i.ibb.co/Pvx3mZ44/images.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#15253b; --muted:#6b7280;
      --border:#e9eef5; --shadow:0 10px 30px rgba(25,35,78,.08); --danger:#dc3545; --info: #0dcaf0;
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
      --border:#263143; --shadow:0 10px 30px rgba(0,0,0,.5); --danger:#f87171;
    }
    
    /* New UI Styles */
    body.new-ui {
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #1e293b 100%);
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
    }
    body.new-ui::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15), transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.12), transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.1), transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    body.new-ui::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,154.7C960,171,1056,181,1152,165.3C1248,149,1344,107,1392,85.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
      background-size: cover;
      pointer-events: none;
      z-index: 0;
    }
    body.new-ui .container {
      position: relative;
      z-index: 1;
    }
    
    body.new-ui .app-card {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5), 0 10px 40px rgba(99, 102, 241, 0.1);
      animation: fadeInUp 0.6s ease-out;
      padding: 32px;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    body.new-ui .title {
      color: #f1f5f9;
      text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.6rem;
      font-weight: 900;
      letter-spacing: -0.5px;
    }
    
    body.new-ui .soft-panel {
      background: rgba(51, 65, 85, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    body.new-ui .soft-panel:hover {
      background: rgba(51, 65, 85, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      border-color: rgba(59, 130, 246, 0.4);
    }
    
    body.new-ui .row-item {
      background: rgba(51, 65, 85, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    body.new-ui .row-item:hover {
      background: rgba(51, 65, 85, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      border-color: rgba(59, 130, 246, 0.4);
    }
    
    body.new-ui .form-control,
    body.new-ui .form-select {
      background: rgba(30, 41, 59, 0.8);
      border: 2px solid rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    body.new-ui .form-select option {
      background: #1e293b;
      color: #e2e8f0;
      padding: 8px;
      font-weight: 500;
    }
    
    body.new-ui .form-select option:checked,
    body.new-ui .form-select option:hover {
      background: #2563eb;
      color: #ffffff;
    }
    
    body.new-ui .form-control::placeholder {
      color: #64748b;
      font-weight: 400;
    }
    
    body.new-ui .form-control:focus,
    body.new-ui .form-select:focus {
      background: rgba(30, 41, 59, 0.95);
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 0 20px rgba(59, 130, 246, 0.4);
      color: #f1f5f9;
    }
    
    body.new-ui .hdr {
      color: #cbd5e1;
      font-weight: 700;
      text-shadow: none;
      letter-spacing: 0.05em;
    }
    
    body.new-ui .btn {
      transition: all 0.3s ease;
      border: none;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      letter-spacing: 0.3px;
      text-transform: none;
      background-size: 100%;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      padding: 12px 24px;
      text-align: center;
    }
    
    body.new-ui .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.5);
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
    }
    
    body.new-ui .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
      color: #fff;
    }
    
    body.new-ui .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5);
      font-weight: 600;
      border: none;
      transition: all 0.3s ease;
    }
    
    body.new-ui .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
      color: #fff;
    }
    
    body.new-ui .btn-icon {
      width: 42px;
      height: 42px;
      padding: 0;
      font-size: 1.1rem;
      border-radius: 10px;
    }
    
    body.new-ui .btn-icon:hover {
      transform: translateY(-2px) scale(1.05);
    }
    
    body.new-ui .qr-display {
      width: 240px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
    }
    
    body.new-ui .qr-actions {
      display: none;
      flex-direction: row;
      gap: 8px;
    }
    
    body.new-ui .qr-display.has-qr .qr-actions {
      display: flex;
    }
    
    body.new-ui .btn-qr-action {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      background: rgba(51, 65, 85, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #cbd5e1;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    
    body.new-ui .btn-qr-action:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3));
      border-color: #3b82f6;
      color: #60a5fa;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 18px rgba(59, 130, 246, 0.4);
    }
    
    body.new-ui .qr-thumb {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    body.new-ui .qr-thumb:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    body.new-ui .btn-secondary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.5);
    }
    
    body.new-ui .btn-secondary:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.6);
      color: #fff;
    }
    
    body.new-ui .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5);
    }
    
    body.new-ui .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
      color: #fff;
    }
    
    body.new-ui .btn-info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5);
    }
    
    body.new-ui .btn-info:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
      color: #fff;
    }
    
    body.new-ui .nav-tabs {
      border-bottom: 2px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 1.5rem;
    }
    
    body.new-ui .nav-tabs .nav-link {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-right: 8px;
      border-radius: 12px 12px 0 0;
      padding: 12px 20px;
      font-size: 0.95rem;
      text-shadow: none;
    }
    
    body.new-ui .nav-tabs .nav-link:hover {
      background: rgba(51, 65, 85, 0.6);
      color: #e2e8f0;
      transform: translateY(-2px);
    }
    
    body.new-ui .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      backdrop-filter: none;
      color: #ffffff;
      border-bottom: none;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.5);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* New UI - File Items */
    body.new-ui .contract-files-container {
      background: rgba(51, 65, 85, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    body.new-ui .contract-files-container .contract-info-header {
      color: #e2e8f0;
      border-bottom-color: rgba(148, 163, 184, 0.2);
      text-shadow: none;
    }
    
    body.new-ui .contract-files-container .contract-info-header strong {
      color: #3b82f6;
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
      font-weight: 800;
    }
    
    body.new-ui .delete-contract-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      opacity: 0.8;
      transition: all 0.3s ease;
    }
    
    body.new-ui .delete-contract-btn:hover {
      opacity: 1;
      transform: scale(1.05);
    }
    
    body.new-ui .file-item {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    body.new-ui .file-item:hover {
      background: rgba(51, 65, 85, 0.8);
      transform: translateX(5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      border-color: rgba(59, 130, 246, 0.4);
    }
    
    body.new-ui .file-item .file-name {
      color: #e2e8f0;
      font-weight: 600;
      text-shadow: none;
    }
    
    body.new-ui .file-item .file-name i {
      color: #3b82f6;
    }
    
    body.new-ui .file-item .file-actions a {
      color: #94a3b8;
      transition: all 0.3s ease;
    }
    
    body.new-ui .file-item .file-actions a:hover {
      color: #3b82f6;
      transform: scale(1.15);
      filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
    }
    
    /* New UI - Lightbox */
    body.new-ui .lightbox {
      background: rgba(0, 0, 0, 0.9);
    }
    
    body.new-ui .lightbox-inner {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.7);
    }
    
    body.new-ui .btn-lightbox {
      background: rgba(51, 65, 85, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(148, 163, 184, 0.3);
      color: #e2e8f0;
      font-weight: 700;
    }
    
    body.new-ui .btn-lightbox:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.5);
      color: #ffffff;
      border-color: #2563eb;
    }
    
    body.new-ui .btn-lightbox.close {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      color: #ffffff;
    }
    
    body.new-ui .btn-lightbox.close:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    }
    
    /* New UI - Toast */
    body.new-ui .toast-notification {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(148, 163, 184, 0.3);
      color: #e2e8f0;
      box-shadow: 0 10px 35px rgba(0, 0, 0, 0.5);
      font-weight: 700;
    }
    
    body.new-ui .toast-notification.info {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      border: none;
      color: #ffffff;
    }
    
    body.new-ui .toast-notification.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border: none;
      color: #ffffff;
    }
    
    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px 0;
      min-width: 150px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      display: none;
    }
    
    .context-menu.show {
      display: block;
    }
    
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      color: var(--ink);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .context-menu-item:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    
    .context-menu-item i {
      width: 16px;
    }
    
    body.new-ui .context-menu {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
    }
    
    body.new-ui .context-menu-item {
      color: #e2e8f0;
    }
    
    body.new-ui .context-menu-item:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }
    
    /* New UI - Calculator specific */
    body.new-ui .calculator-input:read-only {
      background: rgba(51, 65, 85, 0.6);
      color: #cbd5e1;
      opacity: 1;
      font-weight: 600;
      border: 2px solid rgba(148, 163, 184, 0.2);
    }
    
    body.new-ui #monthly-installment {
      color: #3b82f6;
      font-weight: 800;
      text-shadow: 0 0 20px rgba(59, 130, 246, 0.7);
      font-size: 1.4rem;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.2) 0%, rgba(29, 78, 216, 0.2) 100%);
      border: 2px solid #3b82f6;
    }
    
    body.new-ui .form-check-label {
      color: #cbd5e1;
      font-weight: 500;
      text-shadow: none;
    }
    
    body.new-ui #pos-address {
      color: #94a3b8;
      font-weight: 500;
      text-shadow: none;
    }
    
    body.new-ui .text-muted {
      color: #94a3b8 !important;
      font-weight: 500;
      text-shadow: none;
    }
    
    body.new-ui .qr-thumb {
      border-color: rgba(148, 163, 184, 0.3);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }
    
    /* Shared Styles */
    body{ background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app-card{ background:var(--card); border:none; border-radius:16px; box-shadow:var(--shadow); padding:24px; }
    .soft-panel{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .title{ font-weight:800; letter-spacing:.2px; color:var(--ink); }
    .hdr { color:var(--muted); font-weight:700; text-transform:uppercase; font-size:.78rem; letter-spacing:.04em }
    .row-item{ background:var(--card); border:1px solid var(--border); border-radius:14px; margin-bottom:12px; padding: 12px; }
    
    .row-line{ display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .field-wrapper { flex: 1 1 180px; }
    .qr-display { 
      display: flex; 
      align-items: center; 
      justify-content: flex-start;
      flex-direction: row;
      gap: 12px;
      width: 240px;
      min-height: 84px;
    }
    
    .qr-actions {
      display: none;
      flex-direction: row;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .qr-display.has-qr .qr-actions {
      display: flex;
      opacity: 1;
    }
    
    .btn-qr-action {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--ink);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      font-size: 0.9rem;
    }
    
    .btn-qr-action:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: #3b82f6;
      color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .row-item .form-control, .soft-panel .form-control, .form-select { border-radius:12px; background:var(--card); color:var(--ink); border-color:var(--border); }
    .form-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none !important; }
    [data-theme="dark"] .form-control::placeholder { color: var(--muted) }
    .row-item .form-control::placeholder, .soft-panel .form-control::placeholder { color:var(--muted); }
    .row-item .form-control.is-invalid { border-color: var(--danger); }
    .row-item .form-control:focus, .soft-panel .form-control:focus, .form-select:focus { box-shadow: none; border-color: var(--border); }
    .row-item .btn{ border-radius:12px; white-space:nowrap; }
    
    /* Icon-only buttons */
    .btn-icon {
      width: 42px;
      height: 42px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 1.1rem;
    }
    
    .qr-thumb{ width:84px; height:84px; border-radius:12px; object-fit:contain; display:none; cursor:zoom-in; border:1px solid var(--border); background:#fff; }

    .error-msg { color: var(--danger); font-size: 0.8rem; margin-top: 4px; display: none; }
    
    /* Brand name input styling */
    .brand-name-input {
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--ink);
        padding: 4px 8px;
        font-size: 0.9rem;
        text-transform: uppercase;
        transition: all 0.2s ease;
    }
    .brand-name-input:focus {
        border-color: var(--info);
        box-shadow: 0 0 0 2px rgba(13, 202, 240, 0.25);
        outline: none;
    }
    .brand-name-input::placeholder {
        color: var(--muted);
        font-style: italic;
    }
    .brand-name-input.updating {
        border-color: var(--warning);
        background: rgba(255, 193, 7, 0.1);
    }
    
    /* Responsive design for brand name input */
    @media (max-width: 768px) {
        .contract-info-header {
            font-size: 1rem !important;
        }
        .brand-name-input {
            max-width: 120px !important;
            font-size: 0.8rem !important;
        }
        /* Ẩn label "Tên hãng:" trên mobile để tiết kiệm space */
        .contract-info-header span:nth-child(3) {
            display: none !important;
        }
    }
    
    /* Styles for file display in Tab 1 */
    .contract-files-container {
        background-color: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .contract-files-container .contract-info-header {
        color: var(--ink);
        margin-bottom: 1rem;
        text-align: center;
        font-size: 1.1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }
    .contract-files-container .contract-info-header strong {
        color: var(--info);
        font-weight: 700;
    }
    .file-item {
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        transition: background-color 0.2s;
    }
    .file-item:hover {
        background-color: #ffffff08;
    }
    .file-item .file-name {
        flex-grow: 1;
        text-decoration: none;
        color: var(--ink);
        font-weight: 500;
    }
     .file-item .file-name i {
        color: var(--muted);
        margin-right: 12px;
        width: 20px;
        text-align: center;
     }
    .file-item .file-actions a {
        color: var(--muted);
        text-decoration: none;
        margin-left: 1.25rem;
        font-size: 1.2rem;
    }
    .file-item .file-actions a:hover {
        color: var(--ink);
    }

    .print-front-btn:disabled, .print-back-btn:disabled {
        cursor: wait;
        opacity: 0.7;
    }


    /* --- Lightbox Styles --- */
    .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; padding:18px; opacity:0; pointer-events:none; transition:opacity .2s ease-out; z-index:9999; }
    .lightbox.show{ opacity:1; pointer-events:auto; }
    .lightbox-inner{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:24px; transform:scale(.92); transition:transform .2s ease-out; max-width:min(520px, 92vw); text-align: center; }
    .lightbox.show .lightbox-inner{ transform:scale(1); }
    .lightbox img{ width:100%; height:auto; display:block; border-radius:10px; margin-bottom: 16px; }
    
    .lightbox-actions { display: flex; justify-content: center; align-items: center; gap: 12px; flex-wrap: wrap; }
    .btn-lightbox {
        border: 0;
        background: #1f2937;
        color: #fff;
        border-radius: 10px;
        padding: .6rem 1rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background .2s;
    }
    [data-theme="dark"] .btn-lightbox { background: #374151; }
    .btn-lightbox:hover { background: #374151; color: #fff; }
    [data-theme="dark"] .btn-lightbox:hover { background: #4b5563; }
    .btn-lightbox.close { background: var(--danger); }
    .btn-lightbox.close:hover { background: var(--danger); opacity: 0.85; }
    .btn-lightbox:disabled { opacity: 0.7; cursor: not-allowed; }
    
    .toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--danger); color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none; }
    .toast-notification.show { top: 30px; opacity: 1; }
    .toast-notification.info { background-color: var(--info); color: var(--ink); }
    .toast-notification.warning { background-color: #ff9800; color: white; }

    /* --- Loan Calculator Styles --- */
    .calculator-form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    @media (min-width: 768px) {
        .calculator-form-group {
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }
        .calculator-form-group > label {
            flex: 0 0 30%;
        }
    }
    .calculator-input, .calculator-select {
        background-color: var(--bg);
        border: 1px solid var(--border);
        color: var(--ink);
        border-radius: 0.5rem;
        padding: 0.75rem;
        width: 100%;
    }
     .calculator-input:read-only {
        background-color: #374151;
        cursor: not-allowed;
        opacity: 0.7;
    }
     [data-theme="dark"] .calculator-input:read-only {
         color: var(--muted);
     }


    /* Dark mode button overrides */
    [data-theme="dark"] .btn-secondary {
        background-color: var(--border);
        border-color: var(--border);
        color: var(--ink);
    }

    [data-theme="dark"] .btn-secondary:hover {
        filter: brightness(1.2);
    }
     [data-theme="dark"] #pos-address {
        color: var(--ink);
    }
    [data-theme="dark"] .form-check-label {
        color: var(--muted);
    }

    [data-theme="dark"] .btn-success, [data-theme="dark"] .btn-primary {
        background-color: #16a34a;
        border-color: #16a34a;
        color: #fff;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    [data-theme="dark"] .btn-primary {
        background-color: #0284c7;
        border-color: #0284c7;
    }
    
     [data-theme="dark"] .btn-info {
        background-color: #0891b2;
        border-color: #0891b2;
        color: #fff;
    }
    [data-theme="dark"] .modal-content {
        background-color: var(--card);
        color: var(--ink);
    }
    [data-theme="dark"] .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }


    [data-theme="dark"] .btn-success:hover, [data-theme="dark"] .btn-primary:hover, [data-theme="dark"] .btn-info:hover {
        filter: brightness(1.2);
    }
    
    /* QR Action buttons for dark mode */
    [data-theme="dark"] .btn-qr-action {
        background: #1e293b;
        border-color: #334155;
        color: #94a3b8;
    }
    
    [data-theme="dark"] .btn-qr-action:hover {
        background: #0284c7;
        border-color: #0ea5e9;
        color: #e0f2fe;
    }

    /* Dark mode tab overrides */
    [data-theme="dark"] .nav-tabs {
        border-bottom-color: var(--border);
    }

    [data-theme="dark"] .nav-tabs .nav-link {
        background: transparent;
        border-color: transparent transparent var(--border);
        color: var(--muted);
    }

    [data-theme="dark"] .nav-tabs .nav-link.active,
    [data-theme="dark"] .nav-tabs .nav-item.show .nav-link {
        background: var(--card);
        border-color: var(--border) var(--border) var(--card);
        color: var(--ink);
    }

    [data-theme="dark"] .nav-tabs .nav-link:hover:not(.active) {
        border-color: transparent transparent var(--border);
        isolation: isolate;
        background: #ffffff10;
    }
    
    /* Mobile Tab Optimization: Single horizontal row */
    .nav-tabs {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden; /* Ngăn cuộn dọc */
        -webkit-overflow-scrolling: touch; /* Cải thiện cảm giác cuộn trên iOS */
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    .nav-tabs::-webkit-scrollbar {
      display: none; /* Chrome, Safari and Opera */
    }
    .nav-tabs .nav-item {
        white-space: nowrap; /* Ensures button text doesn't wrap */
    }

    /* Custom color overrides */
    [data-theme="dark"] #contract-files-display > p.text-muted {
        color: #f8fafc !important; /* Brighter white for placeholder */
    }
    
    [data-theme="dark"] #calculator-tab-pane .calculator-input {
        color: #f8fafc;
    }

    [data-theme="dark"] #calculator-tab-pane .calculator-input:read-only {
         opacity: 1; /* Ensure readonly fields are not dimmed */
         color: #f8fafc; /* Override the default muted color for readonly */
    }

    [data-theme="dark"] #monthly-installment {
        color: #38bdf8; /* Bright light blue */
    }

    /* Mobile optimization for ED calculator */
    @media (max-width: 767px) {
        #calculator-tab-pane {
            padding: 0.5rem !important;
        }
        #calculator-tab-pane .soft-panel {
            margin-top: 0.5rem !important;
            margin-bottom: 0.5rem !important;
            padding: 0.75rem;
        }
        .calculator-form-group {
            margin-bottom: 0.5rem;
            gap: 0.25rem;
        }
        .calculator-form-group > label.hdr {
            font-size: .7rem;
            margin-bottom: 0;
        }
        .calculator-input, .calculator-select {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        #monthly-installment {
            font-size: 1.1rem !important;
        }
    }

    /* QR Tab Alignment on Desktop */
    @media (min-width: 768px) {
        .row-item .row-line .field-wrapper:nth-child(1) { flex: 0 0 230px; }
        .row-item .row-line .field-wrapper:nth-child(2) { flex: 0 0 260px; }
        .row-item .row-line .field-wrapper:nth-child(3) { flex: 0 0 170px; }
    }

    /* Advisor input updating feedback */
    .form-control.updating {
        border-color: #ffc107 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
        background-color: rgba(255, 193, 7, 0.05) !important;
    }
  </style>
  
  <!-- Thư viện PDF.js và pdf-lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    // Set PDF.js worker to avoid deprecated warning
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body class="new-ui">
  <!-- Main Editor View -->
  <div class="container py-4" id="root">
    <div class="app-card mx-auto" style="max-width:1100px">
      <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
        <h3 class="title mb-0">HD SAISON: Xử Lý Hợp Đồng & Tạo QR Thanh Toán</h3>
        <label for="pdfFile" class="btn btn-secondary px-3" id="uploadPdfLabel">
            <i class="fa-solid fa-file-pdf"></i> Tải File Hợp đồng
        </label>
        <input type="file" id="pdfFile" accept=".pdf" class="d-none" multiple />
      </div>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="print-contract-tab" data-bs-toggle="tab" data-bs-target="#print-contract-tab-pane" type="button" role="tab" aria-controls="print-contract-tab-pane" aria-selected="true">In bộ hợp đồng</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="qr-generator-tab" data-bs-toggle="tab" data-bs-target="#qr-generator-tab-pane" type="button" role="tab" aria-controls="qr-generator-tab-pane" aria-selected="false">Tạo mã QR</button>
        </li>
         <li class="nav-item" role="presentation">
          <button class="nav-link" id="calculator-tab" data-bs-toggle="tab" data-bs-target="#calculator-tab-pane" type="button" role="tab" aria-controls="calculator-tab-pane" aria-selected="false">Tính Khoản Vay (ED)</button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="myTabContent">
        <div class="tab-pane fade show active" id="print-contract-tab-pane" role="tabpanel" aria-labelledby="print-contract-tab" tabindex="0">
           <div class="soft-panel my-3">
                <label for="pos-select" class="hdr mb-2">Chọn POS</label>
                <select class="form-select" id="pos-select">
                    <option value="POS24414">POS24414</option>
                    <option value="POS13858">POS13858</option>
                </select>
                <p id="pos-address" class="small mt-2 mb-0"></p>
            </div>
            
            <!-- Thông tin nhân viên tư vấn -->
            <div class="soft-panel my-3">
                <label class="hdr mb-2">Thông tin nhân viên tư vấn</label>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label for="advisor-name" class="form-label">Nhân viên tư vấn</label>
                        <input type="text" class="form-control" id="advisor-name" placeholder="Nhập tên nhân viên tư vấn">
                    </div>
                    <div class="col-md-4">
                        <label for="advisor-phone" class="form-label">SĐT</label>
                        <input type="tel" class="form-control" id="advisor-phone" placeholder="Nhập số điện thoại">
                    </div>
                </div>
            </div>
            <div id="contract-files-display">
                <p class="text-center text-muted mt-4">Tải lên file PDF hợp đồng để các file được xử lý tự động hiển thị tại đây.<br></p>
            </div>
        </div>
        
        <div class="tab-pane fade" id="qr-generator-tab-pane" role="tabpanel" aria-labelledby="qr-generator-tab" tabindex="0">
             <div class="d-none d-md-flex align-items-center justify-content-between px-3 mb-3 mt-3">
                <div class="d-flex align-items-center gap-2" style="flex-grow: 1;">
                  <div class="hdr" style="flex: 0 0 230px; padding-left: 12px;">SỐ HỢP ĐỒNG</div>
                  <div class="hdr" style="flex: 0 0 260px; padding-left: 12px;">HỌ TÊN</div>
                  <div class="hdr" style="flex: 0 0 170px; padding-left: 12px;">SỐ TIỀN (VND)</div>
                </div>
                <div style="width: 240px;"> <!-- Placeholder for QR + actions -->
                </div>
             </div>
             <div id="rows"></div>
             <p id="qr-placeholder" class="text-center text-muted mt-4" style="display: none;">Chưa có mã QR nào. <br/>Tải file PDF hợp đồng hoặc thêm thủ công để bắt đầu.</p>
        </div>

        <div class="tab-pane fade p-3" id="calculator-tab-pane" role="tabpanel" aria-labelledby="calculator-tab" tabindex="0">
             <div class="soft-panel my-4">
                <div class="calculator-form-group">
                    <label for="loan-program" class="hdr">Chương trình vay</label>
                    <select id="loan-program" class="form-select calculator-select">
                        <option value="0" selected>Lãi suất 0%</option>
                        <option value="0.005">Lãi suất 0.5%</option>
                        <option value="0.01">Lãi suất 1%</option>
                        <option value="regular">Lãi thường</option>
                    </select>
                </div>
                 <div class="calculator-form-group">
                    <label for="product-price" class="hdr">Giá Sản Phẩm</label>
                    <div class="input-group">
                        <input type="text" inputmode="numeric" id="product-price" placeholder="Nhập giá sản phẩm" class="form-control calculator-input">
                        <button id="clear-ed" type="button" class="btn btn-danger">Xoá</button>
                    </div>
                </div>
                 <div class="calculator-form-group">
                    <label for="down-payment-percentage" class="hdr">Trả trước</label>
                     <div class="input-group">
                        <input type="text" inputmode="numeric" id="down-payment-percentage" placeholder="%" class="form-control calculator-input text-center" style="flex: 0 0 70px;">
                        <input type="text" inputmode="numeric" id="down-payment" placeholder="Hoặc nhập số tiền" class="form-control calculator-input">
                    </div>
                </div>
                 <div class="calculator-form-group">
                    <label for="loan-amount" class="hdr">Số tiền vay</label>
                    <input type="text" id="loan-amount" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                <div class="calculator-form-group">
                    <label for="loan-term" class="hdr">Số tháng</label>
                    <select id="loan-term" class="form-select calculator-select">
                        <option value="6" selected>6 tháng</option>
                        <option value="7">7 tháng</option>
                        <option value="9">9 tháng</option>
                        <option value="12">12 tháng</option>
                        <option value="15">15 tháng</option>
                        <option value="24">24 tháng</option>
                    </select>
                </div>
                 <div class="calculator-form-group">
                     <div class="w-full d-flex justify-content-md-end">
                         <div class="form-check">
                            <input id="include-insurance" type="checkbox" checked class="form-check-input">
                            <label for="include-insurance" class="form-check-label text-muted">Bao gồm bảo hiểm khoản vay</label>
                        </div>
                     </div>
                </div>
                 <div class="calculator-form-group">
                    <label for="monthly-difference" class="hdr">Phí chênh lệch (tháng)</label>
                    <input type="text" id="monthly-difference" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                 <div class="calculator-form-group">
                    <label for="total-price-with-fees" class="hdr">Tổng tiền gồm phí</label>
                    <input type="text" id="total-price-with-fees" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                <div class="calculator-form-group">
                    <label for="total-difference" class="hdr">Tổng tiền chênh lệch</label>
                    <input type="text" id="total-difference" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                 <div class="calculator-form-group">
                    <label for="monthly-installment" class="hdr">Số tiền góp mỗi tháng</label>
                    <input type="text" id="monthly-installment" readonly placeholder="Tự động tính" class="form-control calculator-input fw-bold" style="font-size: 1.2rem;">
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared Link Viewer -->
  <div class="container py-4" id="viewer" style="display: none;">
    <div class="app-card mx-auto" style="max-width: 520px; text-align: center;">
        <h3 class="title mb-3">Mã QR Thanh Toán</h3>
        <img id="viewerImg" alt="VietQR Code" style="width: 100%; max-width: 400px; height: auto; border-radius: 16px; margin-bottom: 1.5rem; background: #fff; padding: 10px;"/>
        <div class="soft-panel" style="text-align: left;">
            <p class="mb-2"><strong>Số hợp đồng:</strong> <span id="viewerContract"></span></p>
            <p class="mb-2"><strong>Họ tên:</strong> <span id="viewerName"></span></p>
            <p class="mb-2"><strong>Số tiền:</strong> <span id="viewerAmount" style="font-weight: bold; color: var(--info);"></span></p>
            <p class="mb-0" id="viewerInsuranceFee" style="display: none;"><strong>Phí bảo hiểm:</strong> <span style="color: var(--info);"></span></p>
        </div>
        <button id="viewerDownloadBtn" class="btn btn-success mt-4">
          <i class="fa-solid fa-download"></i> Tải xuống
        </button>
    </div>
  </div>

  <!-- Lightbox Structure -->
  <div id="lb" class="lightbox" aria-hidden="true">
    <div class="lightbox-inner">
      <img id="lbImg" alt="VietQR phóng to"/>
      <div class="lightbox-actions">
          <a class="btn-lightbox download-qr" href="#" download title="Tải ảnh QR">
              <i class="fa-solid fa-download"></i> Tải xuống
          </a>
           <button type="button" class="btn-lightbox print-qr" title="In mã QR">
              <i class="fa-solid fa-print"></i> In QR
          </button>
          <button type="button" class="btn-lightbox" id="shareBtn" title="Chia sẻ">
              <i class="fa-solid fa-share-nodes"></i> Chia sẻ
          </button>
          <button type="button" class="btn-lightbox close" id="lbClose" title="Đóng">
              <i class="fa-solid fa-xmark"></i> Đóng
          </button>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast-notification"></div>
  
  <!-- Context Menu for Row Deletion -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" id="addRowContextMenu">
      <i class="fa-solid fa-plus"></i>
      <span>Thêm dòng mới</span>
    </div>
    <div class="context-menu-item" id="deleteRowContextMenu">
      <i class="fa-solid fa-trash-can"></i>
      <span>Xóa dòng này</span>
    </div>
  </div>

  <template id="rowTemplate">
    <div class="row-item">
      <div class="row-line">
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Số hợp đồng</label>
            <input class="form-control contractInput" placeholder="VD: ED01234567"/>
            <div class="error-msg"></div>
        </div>
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Họ tên</label>
            <input class="form-control nameInput" placeholder="VD: Nguyễn Văn A (Không bắt buộc)"/>
            <div class="error-msg"></div>
        </div>
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Số tiền (VND)</label>
            <input class="form-control amountInput" inputmode="numeric" placeholder="VD: 1.000.000"/>
            <div class="error-msg"></div>
        </div>
        <div class="qr-display">
            <img class="qr-thumb" alt="QR preview" title="Click để phóng to"/>
            <div class="qr-actions">
                <button class="btn-qr-action print-qr-btn" title="In QR">
                    <i class="fa-solid fa-print"></i>
                </button>
                <a class="btn-qr-action download-qr-btn" href="#" download title="Tải xuống QR">
                    <i class="fa-solid fa-download"></i>
                </a>
                <button class="btn-qr-action share-qr-btn" title="Chia sẻ">
                    <i class="fa-solid fa-share-nodes"></i>
                </button>
            </div>
        </div>
      </div>
    </div>
  </template>
  
  <footer id="footer" class="text-center py-4">
    <p class="mb-0" style="font-size: 0.8rem; color: var(--muted);">Phát triển bởi Huỳnh Hải Đăng</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- Elements ---
    const pdfUpload = document.getElementById('pdfFile');
    const uploadPdfLabel = document.getElementById('uploadPdfLabel');
    const { PDFDocument, rgb } = PDFLib;
    const rowsEl = document.getElementById("rows");
    const tpl = document.getElementById("rowTemplate");
    const lb = document.getElementById("lb");
    const lbImg = document.getElementById("lbImg");
    const lbClose = document.getElementById("lbClose");
    const shareBtn = document.getElementById("shareBtn");
    const downloadQrBtn = lb.querySelector(".download-qr");
    const printQrBtn = lb.querySelector(".print-qr");
    const contractDataStore = new Map();
    const contractFilesStore = new Map();
    const qrPlaceholder = document.getElementById("qr-placeholder");

    const POS_INFO = {
        "POS24414": {
            address: "Số 5 Lý Thường Kiệt, KP. Thắng Lợi 1, P. Dĩ An, TP. Dĩ An, Bình Dương",
            templateUrl: 'https://rawcdn.githack.com/shikinora2/VietQR-HDSAISON/e77ada21e72f381e5d8aaa2aecc7b9851fece42d/PDK0IR%20-%20DMCL%20(2).pdf'
        },
        "POS13858": {
            address: "5A/2, Đường DT743, KP.1B, P. An Phú, Thuận An, Bình Dương",
            templateUrl: 'https://rawcdn.githack.com/shikinora2/VietQR-HDSAISON/e77ada21e72f381e5d8aaa2aecc7b9851fece42d/PDK0IR%20-%20DMCL%2013858.pdf'
        }
    };
    const FONT_URL = 'https://rawcdn.githack.com/shikinora2/VietQR-HDSAISON/f0381eb2e75227df3ceeb4ff3e8979f11229af35/SVN-Times%20New%20Roman%20Bold.ttf';
    const POS_STORAGE_KEY = 'selectedPos';
    const CACHED_RESOURCES = {};


    // --- Helper & Utility Functions ---
    function stripVietnamese(str) {
        return (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/gi, "d");
    }

    function digitsOnly(str) {
        return String(str || "").replace(/\D/g, "");
    }

    function formatThousandDots(numStr) {
        return digitsOnly(numStr).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
     function parseNumber(str) {
        if (!str) return 0;
        return Number(String(str).replace(/[^0-9]/g, '')) || 0;
    }

    async function fetchWithRetry(url, retries = 3, delay = 500) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                return await response.arrayBuffer();
            } catch (error) {
                console.error(`Attempt ${i + 1} failed for ${url}:`, error);
                if (i === retries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
            }
        }
    }

    async function getRequiredResources(pos) {
        try {
            if (!pos || !POS_INFO[pos]) {
                throw new Error(`Vị trí POS không hợp lệ: ${pos}`);
            }
            
            if (!CACHED_RESOURCES.font) {
                 showToast('Đang tải font chữ...', 'info');
                 CACHED_RESOURCES.font = await fetchWithRetry(FONT_URL);
            }
            if (!CACHED_RESOURCES[pos]) {
                showToast(`Đang tải mẫu cho ${pos}...`, 'info');
                CACHED_RESOURCES[pos] = await fetchWithRetry(POS_INFO[pos].templateUrl);
            }
            return {
                fontBytes: CACHED_RESOURCES.font,
                templateBytes: CACHED_RESOURCES[pos]
            };
        } catch(error) {
            console.error("Lỗi nghiêm trọng khi tải tài nguyên:", error);
            showToast(`Lỗi tải tài nguyên: ${error.message}. Vui lòng thử lại.`);
            throw error; // Propagate the error to stop processing
        }
    }


    // --- Event Listeners ---
    uploadPdfLabel.addEventListener('click', (e) => {
        e.preventDefault();
        if (!uploadPdfLabel.classList.contains('disabled')) {
            pdfUpload.click();
        }
    });
    pdfUpload.addEventListener('change', handlePdfUpload);
    
    // Context menu handlers
    document.addEventListener("click", (e) => {
        const contextMenu = document.getElementById("contextMenu");
        if (!contextMenu.contains(e.target)) {
            contextMenu.classList.remove("show");
        }
    });
    
    document.getElementById("addRowContextMenu").addEventListener("click", () => {
        const contextMenu = document.getElementById("contextMenu");
        const rowId = contextMenu.dataset.targetRow;
        
        // Add a new row right after the current row
        const newRow = addRow(true);
        
        if (rowId) {
            const currentRow = document.querySelector(`.row-item[data-row-id="${rowId}"]`);
            if (currentRow && newRow) {
                // Insert the new row after the current row
                currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
            }
        }
        
        // Hiển thị lại tùy chọn xóa
        const deleteOption = document.getElementById("deleteRowContextMenu");
        deleteOption.style.display = 'flex';
        
        contextMenu.classList.remove("show");
        showToast("Đã thêm dòng mới!", "info");
    });
    
    document.getElementById("deleteRowContextMenu").addEventListener("click", () => {
        const contextMenu = document.getElementById("contextMenu");
        const rowId = contextMenu.dataset.targetRow;
        if (rowId) {
            const row = document.querySelector(`.row-item[data-row-id="${rowId}"]`);
            if (row && row.deleteRow) {
                row.deleteRow();
            }
        }
        contextMenu.classList.remove("show");
    });
    
    // Context menu cho container #rows (để thêm dòng khi không có row nào)
    const rowsContainer = document.getElementById("rows");
    if (rowsContainer) {
        rowsContainer.addEventListener("contextmenu", (e) => {
            // Chỉ xử lý nếu click vào container trống (không phải vào row-item)
            if (!e.target.closest('.row-item')) {
                e.preventDefault();
                const contextMenu = document.getElementById("contextMenu");
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.classList.add("show");
                
                // Không có row target, chỉ hiển thị "Thêm dòng mới"
                contextMenu.dataset.targetRow = '';
                
                // Ẩn tùy chọn xóa khi click vào vùng trống
                const deleteOption = document.getElementById("deleteRowContextMenu");
                deleteOption.style.display = 'none';
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        let isInitialLoad = true; // Flag to handle initial tab switching

        handleSharedLink();
        
        // Check if there are contract file displays but no data in store (after page refresh)
        const contractContainers = document.querySelectorAll('.contract-files-container');
        if (contractContainers.length > 0 && contractFilesStore.size === 0) {
            console.warn('Phát hiện file hợp đồng cũ sau khi refresh trang. Dữ liệu in đã bị mất.');
            showToast('⚠️ Lưu ý: Để sử dụng chức năng in, vui lòng tải lại file PDF hợp đồng.', 'warning');
        }
        
        document.getElementById('contract-files-display').addEventListener('click', async (e) => {
            const frontBtn = e.target.closest('.print-front-btn');
            const backBtn = e.target.closest('.print-back-btn');

            if (frontBtn) {
                const contractId = frontBtn.dataset.contractId.trim();
                await combinePdfsForPrinting(contractId, 'front');
            } else if (backBtn) {
                const contractId = backBtn.dataset.contractId.trim();
                await combinePdfsForPrinting(contractId, 'back');
            }
        });

        const posSelect = document.getElementById('pos-select');
        const posAddress = document.getElementById('pos-address');

        function updatePosAddress() {
            const selectedPos = posSelect.value;
            posAddress.textContent = POS_INFO[selectedPos]?.address || '';
        }

        const savedPos = localStorage.getItem(POS_STORAGE_KEY);
        if (savedPos) posSelect.value = savedPos;
        
        posSelect.addEventListener('change', () => {
            updatePosAddress();
            localStorage.setItem(POS_STORAGE_KEY, posSelect.value);
            updateAllPdkFiles();
        });
        updatePosAddress();
        
        // Loan Calculator ED Listeners
        ['loan-program', 'loan-term', 'include-insurance'].forEach(id => document.getElementById(id).addEventListener('change', calculateLoanEd));
        document.getElementById('clear-ed').addEventListener('click', resetEdForm);

        const productPriceInput = document.getElementById('product-price');
        const downPaymentAmountInput = document.getElementById('down-payment');
        const downPaymentPercentInput = document.getElementById('down-payment-percentage');
        
        productPriceInput.addEventListener('input', (e) => {
            formatCurrencyOnLoanInput(e); // This calls calculateLoanEd()
            const percentage = parseFloat(downPaymentPercentInput.value);
            if (!isNaN(percentage)) {
                const productPrice = parseNumber(productPriceInput.value);
                const amount = productPrice * (percentage / 100);
                downPaymentAmountInput.value = Math.round(amount).toLocaleString('vi-VN');
                calculateLoanEd();
            }
        });

        downPaymentAmountInput.addEventListener('input', (e) => {
            const { target: input } = e;
            const { value, selectionStart } = input;
            const numericValue = parseNumber(value);
            const formattedValue = numericValue > 0 ? numericValue.toLocaleString('vi-VN') : '';
            input.value = formattedValue;
            try {
                input.setSelectionRange(selectionStart + (formattedValue.length - value.length), selectionStart + (formattedValue.length - value.length));
            } catch (err) {}
            
            const productPrice = parseNumber(productPriceInput.value);
            const downPaymentAmount = parseNumber(formattedValue);

            if (productPrice > 0 && downPaymentAmount >= 0 && downPaymentAmount <= productPrice) {
                const percentage = (downPaymentAmount / productPrice) * 100;
                downPaymentPercentInput.value = Math.round(percentage);
            } else {
                downPaymentPercentInput.value = '';
            }
            
            calculateLoanEd();
        });

        downPaymentPercentInput.addEventListener('input', () => {
            const productPrice = parseNumber(productPriceInput.value);
            let percentageStr = downPaymentPercentInput.value.replace(/[^0-9]/g, '');
            let percentage = parseFloat(percentageStr);

            if (percentage > 100) {
                percentage = 100;
                percentageStr = '100';
            }
            downPaymentPercentInput.value = percentageStr;
            
            if (productPrice > 0 && !isNaN(percentage)) {
                const amount = productPrice * (percentage / 100);
                downPaymentAmountInput.value = Math.round(amount).toLocaleString('vi-VN');
            } else {
                downPaymentAmountInput.value = '';
            }
            
            calculateLoanEd();
        });
        
        function adjustLayoutForScreenSize() {
            const isMobile = window.innerWidth < 768;
            
            const printTab = document.querySelector('#print-contract-tab').closest('.nav-item');
            const qrTab = document.querySelector('#qr-generator-tab').closest('.nav-item');
            const calculatorTab = document.querySelector('#calculator-tab').closest('.nav-item');

            if (isMobile) {
                calculatorTab.style.order = '1';
                qrTab.style.order = '2';
                printTab.style.order = '3';
                
                // [FIX] Only switch to the calculator tab on the very first page load on mobile
                if (isInitialLoad) {
                    const calculatorTabBtn = new bootstrap.Tab(document.getElementById('calculator-tab'));
                    calculatorTabBtn.show();
                }

            } else {
                printTab.style.order = '';
                qrTab.style.order = '';
                calculatorTab.style.order = '';

                // [FIX] Only switch to the print contract tab on the very first page load on desktop
                if (isInitialLoad && !document.getElementById('print-contract-tab').classList.contains('active')) {
                     const printTabBtn = new bootstrap.Tab(document.getElementById('print-contract-tab'));
                     printTabBtn.show();
                }
            }
        }

        adjustLayoutForScreenSize(); // Initial check on page load
        isInitialLoad = false; // [FIX] Set the flag to false after the first run to prevent further automatic switching
        window.addEventListener('resize', adjustLayoutForScreenSize);

        calculateLoanEd();
        addRow(true);
    });
    
    // --- PDK 0% PDF Generation ---
    const PDK_COORDS = {
      "tenKH": { "x": 143.32, "y": 616.87 }, "sdt": { "x": 143.32, "y": 603.04 }, "sanPham": { "x": 117.31, "y": 465.25 },
      "giaBan": { "x": 112.88, "y": 444.78 }, "ngayGiaoDich": { "x": 140.00, "y": 425.97 }, "tienVay": { "x": 122.84, "y": 385.57 },
      "traTruoc": { "x": 145.53, "y": 366.20 }, "thoiHan": { "x": 147.19, "y": 345.73 }, "shd": { "x": 146.08, "y": 325.81 }
    };
    
    function formatCurrency(numStr) {
        if (typeof numStr === 'number') numStr = String(numStr);
        if (!numStr || isNaN(Number(digitsOnly(numStr)))) return "0 VNĐ";
        return formatThousandDots(numStr) + ' VNĐ';
    }
    
    async function generatePdkPdfBytes(pdkData, templateBytes, fontBytes, brandName = '') {
        try {
            if (!pdkData) throw new Error("PDK data không hợp lệ");
            if (!templateBytes) throw new Error("Template bytes không hợp lệ");
            if (!fontBytes) throw new Error("Font bytes không hợp lệ");
            
            console.log("Loading PDF template...");
            const pdfDoc = await PDFDocument.load(templateBytes);
            pdfDoc.registerFontkit(fontkit);
            
            console.log("Embedding font...");
            const font = await pdfDoc.embedFont(fontBytes, { subset: false }); // Không subset để giữ toàn bộ font
            const page = pdfDoc.getPages()[0];
            const today = new Date().toLocaleDateString('vi-VN');
        
        for (const key in PDK_COORDS) {
            let text = (key === 'ngayGiaoDich') ? today : pdkData[key] || '';
            if (['giaBan', 'tienVay', 'traTruoc'].includes(key)) {
                text = formatCurrency(text);
            }
            // Chèn tên hãng vào sau tên sản phẩm nếu có (IN HOA)
            if (key === 'sanPham' && brandName) {
                const upperBrandName = brandName.toUpperCase();
                text = text ? `${text} ${upperBrandName}` : upperBrandName;
            }
            page.drawText(text, { ...PDK_COORDS[key], font, size: 13, color: rgb(0, 0, 0), maxWidth: 400 });
        }
        
        console.log("Saving PDF...");
        return await pdfDoc.save();
        } catch (error) {
            console.error("Lỗi trong generatePdkPdfBytes:", error);
            throw new Error(`Tạo PDK thất bại: ${error.message || error}`);
        }
    }

    async function regeneratePdkWithBrandName(contractId) {
        try {
            const contractData = contractDataStore.get(contractId);
            if (!contractData || !contractData.pdkData) return;

            const brandName = contractData.brandName || '';
            console.log(`Regenerating PDK for ${contractId} with brand: ${brandName || '(no brand)'}`);

            // Use cached resources
            const selectedPos = document.getElementById('pos-select').value;
            const { fontBytes, templateBytes } = await getRequiredResources(selectedPos);

            // Generate new PDK with brand name
            const pdkPdfBytes = await generatePdkPdfBytes(contractData.pdkData, templateBytes, fontBytes, brandName);
            console.log(`Generated PDK bytes length: ${pdkPdfBytes.byteLength}`);
            
            // Update file in store
            const fileSet = contractFilesStore.get(contractId);
            if (fileSet && fileSet.pdk) {
                // Revoke old URL
                URL.revokeObjectURL(fileSet.pdk.url);
                
                // Create new blob and URL
                const blob = new Blob([pdkPdfBytes], { type: 'application/pdf' });
                const newUrl = URL.createObjectURL(blob);
                
                // Cập nhật tên file để phản ánh brand name
                const baseFileName = `PDK_0%_${contractData.pdkData.shd}`;
                const newFileName = brandName ? `${baseFileName}_${brandName.toUpperCase()}.pdf` : `${baseFileName}.pdf`;
                
                fileSet.pdk.url = newUrl;
                fileSet.pdk.blob = blob; // Cập nhật cả blob property
                fileSet.pdk.name = newFileName; // Cập nhật tên file
                contractFilesStore.set(contractId, fileSet);
                
                console.log(`Updated PDK URL for ${contractId}: ${newUrl}`);
                showToast(`Đã cập nhật file PDK cho hợp đồng ${contractId}`, 'info');
                
                // Force refresh UI to show updated file
                updateContractFileLinks(contractId, fileSet);
            }
        } catch (error) {
            console.error(`Lỗi khi tạo lại PDK cho ${contractId}:`, error);
            showToast(`Lỗi cập nhật PDK: ${error.message}`);
        }
    }

    function updateContractFileLinks(contractId, fileSet) {
        try {
            const wrapper = document.querySelector(`.contract-files-container[data-contract-id="${contractId}"]`);
            if (!wrapper) return;
            
            // Cập nhật tất cả links cho file PDK
            if (fileSet.pdk) {
                const pdkFileItem = wrapper.querySelector('.file-item[data-file-type="pdk"]');
                if (pdkFileItem) {
                    // Cập nhật tất cả các links trong file item
                    const links = pdkFileItem.querySelectorAll('a[href]');
                    links.forEach(link => {
                        const isDownloadLink = link.hasAttribute('download');
                        if (isDownloadLink) {
                            link.download = fileSet.pdk.name;
                        }
                        link.href = fileSet.pdk.url;
                    });
                    console.log(`Updated ${links.length} PDK links for ${contractId}`);
                }
            }
        } catch (error) {
            console.error(`Lỗi cập nhật file links cho ${contractId}:`, error);
        }
    }
    
    function updatePlaceholders() {
        qrPlaceholder.style.display = rowsEl.children.length === 0 ? 'block' : 'none';
        const fileDisplay = document.getElementById('contract-files-display');
        const placeholder = fileDisplay.querySelector(':scope > p.text-muted');
        if (placeholder) {
            const hasContracts = fileDisplay.querySelector('.contract-files-container');
            placeholder.style.display = hasContracts ? 'none' : 'block';
        }
    }

    async function updateAllPdkFiles() {
        if (contractDataStore.size === 0) return;
        showToast('Đang cập nhật file PDK theo POS mới...', 'info');
        try {
            const selectedPos = document.getElementById('pos-select').value;
            const { fontBytes, templateBytes } = await getRequiredResources(selectedPos);

            for (const [contractId, contractData] of contractDataStore.entries()) {
                const { pdkData } = contractData;
                if (!pdkData || !pdkData.shd) continue;

                const brandName = contractData.brandName || '';
                const newPdkBytes = await generatePdkPdfBytes(pdkData, templateBytes, fontBytes, brandName);
                const newPdkBlobUrl = URL.createObjectURL(new Blob([newPdkBytes], { type: 'application/pdf' }));
                
                const fileSet = contractFilesStore.get(contractId);
                if (!fileSet) continue;
                if (fileSet.pdk && fileSet.pdk.url) URL.revokeObjectURL(fileSet.pdk.url);

                fileSet.pdk.url = newPdkBlobUrl;
                const fileContainer = document.querySelector(`.contract-files-container[data-contract-id="${contractId}"]`);
                if (fileContainer) {
                    const pdkItem = fileContainer.querySelector('.file-item[data-file-type="pdk"]'); 
                    if (pdkItem) {
                        const link = pdkItem.querySelector('a.file-name');
                        const printLink = pdkItem.querySelector('.file-actions a[title="In"]');
                        const downloadLink = pdkItem.querySelector('.file-actions a[title="Tải về"]');
                        if (link) link.href = newPdkBlobUrl;
                        if (printLink) printLink.href = newPdkBlobUrl;
                        if (downloadLink) downloadLink.href = newPdkBlobUrl;
                    }
                }
            }
            showToast('Đã cập nhật tất cả file PDK!', 'info');
        } catch (error) {
            console.error("Lỗi khi cập nhật file PDK:", error);
            // Error is already shown by getRequiredResources
        }
    }
    
    function findEmptyRow() {
        const rows = document.querySelectorAll('#rows .row-item');
        for (const row of rows) {
            const contractInput = row.querySelector(".contractInput");
            const nameInput = row.querySelector(".nameInput");
            const amountInput = row.querySelector(".amountInput");
            const qrThumb = row.querySelector(".qr-thumb");
            
            // Tìm dòng trống (chưa có dữ liệu và chưa có QR)
            const isEmpty = contractInput.value.trim() === '' && 
                           nameInput.value.trim() === '' && 
                           amountInput.value.trim() === '';
            const hasNoQR = !qrThumb.src || qrThumb.style.display === "none";
            
            if (isEmpty && hasNoQR) {
                return row;
            }
        }
        return null; // No empty row found
    }

    // --- Core Functions ---
    async function processSinglePdf(file, fileIndex, totalFiles) {
        uploadPdfLabel.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Xử lý ${fileIndex + 1}/${totalFiles}`;
        try {
            if (file.type !== 'application/pdf') throw new Error("File không phải là PDF");
            
            const pdfBuffer = await file.arrayBuffer();
            let paymentPageNum = -1, paymentPageText = '', insurancePageNum = -1, fullText = '';
            const pdf = await pdfjsLib.getDocument(new Uint8Array(pdfBuffer)).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
                if (pageText.includes('HƯỚNG DẪN THANH TOÁN')) {
                    paymentPageNum = i;
                    paymentPageText = pageText;
                }
                if (pageText.includes('BẢN YÊU CẦU BẢO HIỂM') && insurancePageNum === -1) {
                    insurancePageNum = i;
                }
            }

            if (!paymentPageText) throw new Error(`Không tìm thấy trang Hướng Dẫn Thanh Toán.`);
            const allData = extractAllDataFromPdfText(fullText, paymentPageText);
            if (!allData.qrData || !allData.pdkData) throw new Error(`Không tìm thấy đủ thông tin trong file.`);
            
            // Validate QR data
            if (!allData.qrData.contract) throw new Error("Không tìm thấy số hợp đồng");
            if (!allData.qrData.name) throw new Error("Không tìm thấy tên khách hàng");
            if (!allData.qrData.amount) throw new Error("Không tìm thấy số tiền thanh toán");
            
            // Validate PDK data
            if (!allData.pdkData.shd) throw new Error("Không tìm thấy số hợp đồng trong PDK data");

            const contractId = allData.qrData.contract.trim();
            
            // Kiểm tra trùng lặp
            if (contractDataStore.has(contractId)) {
                console.log(`⚠️ Bỏ qua file trùng: Hợp đồng ${contractId} đã tồn tại`);
                return { success: true, skipped: true, contractId };
            }

            let rowEl = findEmptyRow();
            if (!rowEl) {
                rowEl = addRow(); 
            }
            
            rowEl.querySelector(".contractInput").value = allData.qrData.contract;
            rowEl.querySelector(".nameInput").value = allData.qrData.name;
            rowEl.querySelector(".amountInput").value = formatThousandDots(allData.qrData.amount);
            if (rowEl.generateQR) rowEl.generateQR();

            allData.paymentPage = paymentPageNum;
            allData.insurancePage = insurancePageNum;
            
            // Add current advisor info to contract data
            const advisorName = document.getElementById('advisor-name')?.value?.trim() || '';
            const advisorPhone = document.getElementById('advisor-phone')?.value?.trim() || '';
            allData.advisorName = advisorName;
            allData.advisorPhone = advisorPhone;
            
            // Load original PDF for future use
            const originalPdfDoc = await PDFDocument.load(pdfBuffer);
            allData.originalPdfDoc = originalPdfDoc;
            
            const contractFullData = { ...allData, pdfBuffer };
            contractDataStore.set(contractId, contractFullData);

            const fileSet = await generateContractFileSet(contractFullData);
            displayContractFilesInUI(fileSet, allData.qrData);
            
            return { success: true, skipped: false, contractId };
        } catch (error) {
            console.error(`Lỗi xử lý file "${file.name}":`, error);
            showToast(`Lỗi file "${file.name}": ${error.message}`);
            return { success: false, skipped: false };
        }
    }

    async function handlePdfUpload(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        const originalBtnHTML = uploadPdfLabel.innerHTML;
        uploadPdfLabel.classList.add('disabled');
        let successCount = 0;
        let errorCount = 0;
        let skippedCount = 0;
        const skippedContracts = [];

        for (let i = 0; i < files.length; i++) {
            const result = await processSinglePdf(files[i], i, files.length);
            if (result.success) {
                successCount++;
                if (result.skipped) {
                    skippedCount++;
                    skippedContracts.push(result.contractId);
                }
            } else {
                errorCount++;
            }
            await new Promise(resolve => setTimeout(resolve, 50)); 
        }

        uploadPdfLabel.innerHTML = originalBtnHTML;
        uploadPdfLabel.classList.remove('disabled');
        event.target.value = '';
        updatePlaceholders();

        // Hiển thị thông báo tổng hợp
        if (files.length > 1) {
            const processedCount = successCount - skippedCount;
            let message = `Hoàn tất: ${processedCount} file mới`;
            if (skippedCount > 0) {
                message += `, ${skippedCount} file trùng (${skippedContracts.join(', ')})`;
            }
            if (errorCount > 0) {
                message += `, ${errorCount} lỗi`;
            }
            showToast(message, errorCount > 0 ? 'error' : 'info');
        } else if (successCount > 0) {
            if (skippedCount > 0) {
                showToast(`⚠️ File trùng: Hợp đồng ${skippedContracts[0]} đã tồn tại`, 'warning');
            } else {
                showToast(`✅ Đã xử lý thành công file PDF`, 'info');
            }
        }
    }
    
    function toTitleCase(str) {
        return (str || '').toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
    function extractAllDataFromPdfText(fullText, paymentPageText) {
        const qrData = {
            contract: paymentPageText.match(/Số Hợp Đồng:\s*([A-Z0-9]+)/)?.[1]?.trim(),
            name: paymentPageText.match(/Họ tên:\s*(.*?)\s*Thông tin Khoản Vay:/)?.[1]?.trim(),
            amount: paymentPageText.match(/Khoản Thanh Toán Hàng Tháng:\s*([\d,.]+)\s*VNĐ/)?.[1]?.trim(),
        };
        
        const findValue = (regex) => fullText.match(regex)?.[1]?.replace('VNĐ', '').trim() || null;
        let tenKH = findValue(/1\.1\.\s*Họ tên:\s*(.*?)\s*1\.2\./);
        
        // Trích xuất phí bảo hiểm từ phần "Bản yêu cầu bảo hiểm"
        const insuranceFee = findValue(/4\.3\.\s*Phí bảo hiểm:\s*([0-9,.]+)\s*VNĐ\/tháng/) || 
                            findValue(/Phí bảo hiểm:\s*([0-9,.]+)\s*VNĐ\/tháng/) ||
                            findValue(/4\.3\.\s*Phí bảo hiểm:\s*([0-9,.]+)/) ||
                            findValue(/Phí bảo hiểm:\s*([0-9,.]+)/);
        
        const pdkData = {
            shd: findValue(/Số:\s*([A-Z0-9]+)/),
            tenKH: tenKH ? toTitleCase(tenKH) : null,
            sdt: findValue(/1\.7\.\s*Điện thoại di động:\s*(\d+)/),
            sanPham: findValue(/5\.9\.1\. Sản Phẩm Được Tài Trợ 1:\s*(.*?)(?:\s*Tổng Giá Bán|\s*5\.9\.2\.)/)?.split(',').map(item => item.trim().replace(/^\d+-/, '')).join(', '),
            giaBan: findValue(/2\.2\. Tổng giá trị Sản Phẩm Được Tài Trợ:\s*([0-9,.]+(?:\s*VNĐ)?)/),
            traTruoc: findValue(/2\.3\. Khoản Tiền Mặt Trả Trước:\s*([0-9,.]+(?:\s*VNĐ)?)/),
            tienVay: findValue(/2\.4\. Số tiền đề nghị vay:\s*([0-9,.]+(?:\s*VNĐ)?)/),
            thoiHan: findValue(/2\.5\. Thời Hạn Vay:\s*(.*?)\s*3\./)
        };
        
        // Thêm phí bảo hiểm vào qrData để hiển thị
        const enhancedQrData = {
            ...qrData,
            insuranceFee: insuranceFee
        };
        
        return {
            qrData: Object.values(qrData).every(Boolean) ? enhancedQrData : null,
            pdkData: Object.values(pdkData).every(Boolean) ? pdkData : null
        };
    }

    // Helper function to fetch QR image with fallback
    async function fetchQRImage(qrData) {
        const templates = ["qr_only.png", "compact.png", "print.png"];
        
        for (const template of templates) {
            try {
                const qrUrl = buildQRUrl(qrData, template);
                console.log(`Trying QR template: ${template} - ${qrUrl}`);
                
                const response = await fetch(qrUrl);
                if (!response.ok) {
                    console.warn(`QR template ${template} failed: ${response.status}`);
                    continue;
                }
                
                const contentType = response.headers.get('content-type');
                console.log(`QR response content-type: ${contentType}`);
                
                if (!contentType || !contentType.includes('image')) {
                    console.warn(`Invalid content-type for ${template}: ${contentType}`);
                    continue;
                }
                
                const imageBytes = await response.arrayBuffer();
                if (imageBytes.byteLength === 0) {
                    console.warn(`Empty response for ${template}`);
                    continue;
                }
                
                // Check if it's a valid image by checking magic bytes
                const uint8Array = new Uint8Array(imageBytes);
                const isPNG = uint8Array.length >= 4 && 
                             uint8Array[0] === 0x89 && uint8Array[1] === 0x50 && 
                             uint8Array[2] === 0x4E && uint8Array[3] === 0x47;
                const isJPEG = uint8Array.length >= 2 && 
                              uint8Array[0] === 0xFF && uint8Array[1] === 0xD8;
                
                // Fallback: Dựa vào content-type nếu magic bytes không rõ ràng
                let finalIsPNG = isPNG;
                let finalIsJPEG = isJPEG;
                
                if (!isPNG && !isJPEG && contentType) {
                    if (contentType.includes('png')) {
                        finalIsPNG = true;
                        console.log(`Detected PNG from content-type: ${contentType}`);
                    } else if (contentType.includes('jpeg') || contentType.includes('jpg')) {
                        finalIsJPEG = true;
                        console.log(`Detected JPEG from content-type: ${contentType}`);
                    }
                }
                
                if (!finalIsPNG && !finalIsJPEG) {
                    console.warn(`Invalid image format for ${template} - ContentType: ${contentType}, Magic: ${uint8Array.slice(0, 4)}`);
                    continue;
                }
                
                console.log(`Successfully fetched ${finalIsPNG ? 'PNG' : 'JPEG'} QR with template: ${template}`);
                return { imageBytes, template, isPNG: finalIsPNG, isJPEG: finalIsJPEG };
                
            } catch (error) {
                console.warn(`Error with template ${template}:`, error);
                continue;
            }
        }
        
        throw new Error("Không thể tải QR code với bất kỳ template nào");
    }
    
    async function generateContractFileSet(contractData) {
        const { pdfBuffer, paymentPage, insurancePage, pdkData } = contractData;
        const fileSet = {};
        
        try {
            // Kiểm tra dữ liệu đầu vào
            if (!pdfBuffer) throw new Error("PDF buffer không hợp lệ");
            if (!pdkData || !pdkData.shd) throw new Error("Dữ liệu PDK không hợp lệ");
            if (!paymentPage || paymentPage < 1) throw new Error("Trang thanh toán không hợp lệ");
            
            const originalPdfDoc = await PDFDocument.load(pdfBuffer);
            const totalPages = originalPdfDoc.getPageCount();

            const hopDongDoc = await PDFDocument.create();
            const hopDongPages = await hopDongDoc.copyPages(originalPdfDoc, [0, 1, 2, 3]);
            hopDongPages.forEach(page => hopDongDoc.addPage(page));
            const hopDongBytes = await hopDongDoc.save();
            fileSet.hopDong = { url: URL.createObjectURL(new Blob([hopDongBytes], { type: 'application/pdf' })), name: `HopDongTinDung_${pdkData.shd}.pdf` };

            const thanhToanDoc = await PDFDocument.create();
            const [thanhToanPage] = await thanhToanDoc.copyPages(originalPdfDoc, [paymentPage - 1]);
            thanhToanDoc.addPage(thanhToanPage);
            
            // Fetch QR image với fallback mechanism
            const { imageBytes: qrImageBytes, template: usedTemplate, isPNG, isJPEG } = await fetchQRImage(contractData.qrData);
            console.log(`Using QR template: ${usedTemplate} (${isPNG ? 'PNG' : 'JPEG'})`);
            
            // Embed image based on detected format
            let qrImage;
            if (isPNG) {
                qrImage = await thanhToanDoc.embedPng(qrImageBytes);
            } else if (isJPEG) {
                qrImage = await thanhToanDoc.embedJpg(qrImageBytes);
            } else {
                throw new Error("Không thể xác định định dạng QR image");
            }
            const { width, height } = thanhToanPage.getSize();
            const qrDims = qrImage.scale(0.20); // Scale to 20% of original size
            thanhToanPage.drawImage(qrImage, { x: width - qrDims.width - 65, y: height - qrDims.height - 65, width: qrDims.width, height: qrDims.height });
            
            // Thêm thông tin nhân viên tư vấn (bên trái QR)
            const advisorName = document.getElementById('advisor-name')?.value?.trim();
            const advisorPhone = document.getElementById('advisor-phone')?.value?.trim();
            
            if (advisorName || advisorPhone) {
                console.log(`Adding advisor info: ${advisorName || 'N/A'} - ${advisorPhone || 'N/A'}`);
                
                // Register fontkit cho thanhToanDoc
                thanhToanDoc.registerFontkit(fontkit);
                
                // Tải font cho advisor info
                const selectedPos = document.getElementById('pos-select')?.value;
                const { fontBytes } = await getRequiredResources(selectedPos);
                const advisorFont = await thanhToanDoc.embedFont(fontBytes, { subset: false });
                
                // Vị trí khung nhân viên tư vấn
                const { width, height } = thanhToanPage.getSize();
                const qrDims = qrImage.scale(0.20); // Kích thước QR sau khi scale
                
                // Tính toán kích thước khung dựa trên nội dung text
                const fontSize = 9;
                const padding = 6;
                const lineHeight = fontSize + 2;
                
                // Tính độ rộng cần thiết cho text
                let maxTextWidth = 0;
                if (advisorName) {
                    const nameWidth = advisorFont.widthOfTextAtSize(advisorName.toUpperCase(), fontSize);
                    maxTextWidth = Math.max(maxTextWidth, nameWidth);
                }
                if (advisorPhone) {
                    const phoneWidth = advisorFont.widthOfTextAtSize(advisorPhone, fontSize);
                    maxTextWidth = Math.max(maxTextWidth, phoneWidth);
                }
                
                // Kích thước khung với padding
                const boxWidth = Math.max(80, maxTextWidth + (padding * 2)); // Tối thiểu 80px
                const boxHeight = (advisorName && advisorPhone) ? 32 : 18; // 2 dòng hoặc 1 dòng
                
                // Căn khung theo cạnh bên phải (từ QR về bên trái)
                const qrX = width - qrDims.width - 65; // Vị trí QR
                const marginFromQR = 5; // Khoảng cách từ QR đến khung (5px)
                const advisorX = qrX - boxWidth - marginFromQR; // Khung sẽ kết thúc cách QR 5px
                const advisorY = height - qrDims.height - 35; // Cùng độ cao với QR
                
                // Vẽ khung chính (nền trắng với viền đen)
                thanhToanPage.drawRectangle({
                    x: advisorX,
                    y: advisorY - boxHeight + padding,
                    width: boxWidth,
                    height: boxHeight,
                    borderColor: rgb(0, 0, 0),           // Viền đen
                    borderWidth: 1.5,                    // Độ dày viền
                    color: rgb(1, 1, 1),                // Nền trắng
                });
                
                let currentY = advisorY - padding - 2; // Vị trí bắt đầu vẽ text (từ trên xuống)
                
                // Vẽ text tên nhân viên (căn trái trong khung)
                if (advisorName) {
                    const nameText = advisorName.toUpperCase();
                    const nameX = advisorX + padding; // Căn trái: cách viền trái padding px
                    
                    thanhToanPage.drawText(nameText, {
                        x: nameX,
                        y: currentY,
                        size: fontSize,
                        font: advisorFont,
                        color: rgb(0, 0, 0)
                    });
                    currentY -= lineHeight; // Xuống dòng
                    
                    // Vẽ đường phân cách nếu có cả tên và SĐT
                    if (advisorPhone) {
                        const separatorY = currentY + 6;
                        thanhToanPage.drawLine({
                            start: { x: advisorX + 2, y: separatorY },
                            end:   { x: advisorX + boxWidth - 2, y: separatorY },
                            thickness: 0.8,
                            color: rgb(0.3, 0.3, 0.3),
                        });
                    }
                }
                
                // Vẽ text số điện thoại (căn trái trong khung)
                if (advisorPhone) {
                    const phoneText = advisorPhone;
                    const phoneX = advisorX + padding; // Căn trái: cách viền trái padding px
                    const phoneYOffset = 5;
                    const phoneY = currentY - phoneYOffset;
                    
                    thanhToanPage.drawText(phoneText, {
                        x: phoneX,
                        y: phoneY,
                        size: fontSize,
                        font: advisorFont,
                        color: rgb(0, 0, 0)
                    });
                }
            }
            
            const thanhToanBytes = await thanhToanDoc.save();
            fileSet.thanhToan = { url: URL.createObjectURL(new Blob([thanhToanBytes], { type: 'application/pdf' })), name: `HuongDanThanhToan_${pdkData.shd}.pdf` };

            if (insurancePage > 0 && insurancePage + 1 <= totalPages) {
                const baoHiemDoc = await PDFDocument.create();
                const baoHiemPages = await baoHiemDoc.copyPages(originalPdfDoc, [insurancePage - 1, insurancePage]);
                baoHiemPages.forEach(page => baoHiemDoc.addPage(page));
                const baoHiemBytes = await baoHiemDoc.save();
                fileSet.baoHiem = { url: URL.createObjectURL(new Blob([baoHiemBytes], { type: 'application/pdf' })), name: `YeuCauBaoHiem_${pdkData.shd}.pdf` };
            }
            
            const selectedPos = document.getElementById('pos-select')?.value;
            if (!selectedPos) {
                throw new Error("Không tìm thấy vị trí POS được chọn");
            }
            
            console.log(`Loading resources for POS: ${selectedPos}`);
            const { fontBytes, templateBytes } = await getRequiredResources(selectedPos);
            
            if (!fontBytes || !templateBytes) {
                throw new Error("Không thể tải font hoặc template");
            }
            
            const brandName = contractData.brandName || '';
            console.log(`Generating PDK with brand: ${brandName}`);
            const pdkBytes = await generatePdkPdfBytes(pdkData, templateBytes, fontBytes, brandName);
            
            // Tạo tên file với brand name nếu có
            const baseFileName = `PDK_0%_${pdkData.shd}`;
            const fileName = brandName ? `${baseFileName}_${brandName.toUpperCase()}.pdf` : `${baseFileName}.pdf`;
            
            fileSet.pdk = { url: URL.createObjectURL(new Blob([pdkBytes], { type: 'application/pdf' })), name: fileName };
            
            const contractId = contractData.qrData.contract.trim();
            contractFilesStore.set(contractId, fileSet);
            console.log(`Đã lưu fileSet cho hợp đồng: "${contractId}"`);
            return fileSet;
        } catch (err) {
            console.error("Lỗi khi tạo bộ file hợp đồng:", err);
            const errorMessage = err?.message || err?.toString() || "Lỗi không xác định";
            throw new Error(`Tạo file thất bại: ${errorMessage}`);
        }
    }
    
    function displayContractFilesInUI(fileSet, contractInfo) {
        if (!contractInfo || !contractInfo.contract || !contractInfo.name) {
            console.error("displayContractFilesInUI: Dữ liệu hợp đồng không hợp lệ.", contractInfo);
            showToast("Không thể hiển thị thông tin hợp đồng do thiếu dữ liệu.");
            return; 
        }

        const contractId = contractInfo.contract.trim();
        const container = document.getElementById('contract-files-display');
        const wrapper = document.createElement('div');
        wrapper.className = 'contract-files-container';
        wrapper.dataset.contractId = contractId;

        const fileItems = [
            { id: 'hopDong', icon: 'fa-file-contract', text: 'Hợp Đồng Tín Dụng' },
            { id: 'thanhToan', icon: 'fa-qrcode', text: 'Hướng Dẫn Thanh Toán (có QR chuyển tiền)' },
            { id: 'baoHiem', icon: 'fa-shield-halved', text: 'Bản Yêu Cầu Bảo Hiểm' },
            { id: 'pdk', icon: 'fa-file-pen', text: 'Phiếu Đăng Ký 0%' }
        ];
        
        let filesHtml = fileItems.map(item => {
            if (!fileSet[item.id]) return '';
            const { url, name } = fileSet[item.id];
            return `
            <div class="file-item" data-file-type="${item.id}">
                <a href="${url}" target="_blank" class="file-name"><i class="fa-solid ${item.icon} fa-fw"></i>${item.text}</a>
                <div class="file-actions">
                    <a href="${url}" target="_blank" title="In"><i class="fa-solid fa-print"></i></a>
                    <a href="${url}" download="${name}" title="Tải về"><i class="fa-solid fa-download"></i></a>
                </div>
            </div>`;
        }).join('');

        // Tạo thông tin phí bảo hiểm
        const insuranceFeeInfo = contractInfo.insuranceFee ? 
            ` - <span style="font-weight: 500;">Phí BH: ${formatThousandDots(contractInfo.insuranceFee)} VNĐ/tháng</span>` : '';
        
        wrapper.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center flex-grow-1 gap-2">
                    <p class="contract-info-header mb-0" style="margin-right: 10px;">
                        <strong>${contractId}</strong> - ${contractInfo.name}${insuranceFeeInfo}
                    </p>
                    <span style="color: var(--muted); font-size: 1.2rem; margin: 0 5px;">|</span>
                    <span style="color: var(--ink); font-size: 0.9rem; margin-right: 5px;">Tên hãng:</span>
                    <input type="text" class="form-control brand-name-input" placeholder="Nhập tên hãng" 
                           style="max-width: 150px; font-size: 0.9rem;" data-contract-id="${contractId}"
                           value="${contractInfo.brandName || ''}"  >
                </div>
                <button class="btn btn-sm btn-danger delete-contract-btn" data-contract-id="${contractId}" title="Xóa hợp đồng này">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            ${filesHtml}
            <div class="d-flex justify-content-center gap-3 mt-3">
                <button class="btn btn-info print-front-btn" data-contract-id="${contractId}"><i class="fa-solid fa-print me-2"></i> In mặt trước</button>
                <button class="btn btn-info print-back-btn" data-contract-id="${contractId}"><i class="fa-solid fa-print me-2"></i> In mặt sau</button>
            </div>
        `;
        container.prepend(wrapper);
        
        // Add delete handler for this contract
        const deleteBtn = wrapper.querySelector('.delete-contract-btn');
        deleteBtn.addEventListener('click', () => {
            if (confirm(`Xóa hợp đồng ${contractId}?`)) {
                // Xóa file container UI
                wrapper.remove();
                
                // Xóa dữ liệu stores
                const fileSet = contractFilesStore.get(contractId);
                if (fileSet) {
                    Object.values(fileSet).forEach(fileInfo => {
                        if (fileInfo && fileInfo.url) URL.revokeObjectURL(fileInfo.url);
                    });
                    contractFilesStore.delete(contractId);
                }
                contractDataStore.delete(contractId);
                
                showToast(`Đã xóa hợp đồng ${contractId}`, 'info');
            }
        });

        // Add brand name input handler
        const brandNameInput = wrapper.querySelector('.brand-name-input');
        let brandNameTimeout;

        const saveBrandName = () => {
            const brandName = brandNameInput.value.trim();
            const contractData = contractDataStore.get(contractId);
            if (contractData) {
                const oldBrandName = contractData.brandName || '';
                contractData.brandName = brandName;
                contractDataStore.set(contractId, contractData);
                
                // Chỉ tạo lại PDK nếu tên hãng thay đổi
                if (oldBrandName !== brandName) {
                    console.log(`Đã lưu tên hãng cho hợp đồng ${contractId}: ${brandName || '(trống)'}`);
                    regeneratePdkWithBrandName(contractId);
                }
            }
        };

        // Handle input with 1-second timeout
        brandNameInput.addEventListener('input', (e) => {
            clearTimeout(brandNameTimeout);
            brandNameInput.classList.add('updating');
            brandNameTimeout = setTimeout(() => {
                saveBrandName();
                brandNameInput.classList.remove('updating');
            }, 1000);
        });

        // Handle Enter key
        brandNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                clearTimeout(brandNameTimeout);
                brandNameInput.classList.remove('updating');
                saveBrandName();
                e.target.blur(); // Remove focus from input
            }
        });
    }

    function addRow(isManual = false) {
        const node = tpl.content.cloneNode(true);
        const el = node.querySelector(".row-item");
        const inputs = {
            contract: el.querySelector(".contractInput"),
            name: el.querySelector(".nameInput"),
            amount: el.querySelector(".amountInput")
        };
        const img = el.querySelector(".qr-thumb");
        const qrDisplay = el.querySelector(".qr-display");
        const printBtn = el.querySelector(".print-qr-btn");
        const downloadBtn = el.querySelector(".download-qr-btn");
        const shareBtn = el.querySelector(".share-qr-btn");
        const errorMessages = {
            contract: el.querySelector(".contractInput + .error-msg"),
            amount: el.querySelector(".amountInput + .error-msg"),
        };
        
        inputs.amount.addEventListener("input", () => {
            const { value, selectionStart } = inputs.amount;
            const originalLength = value.length;
            inputs.amount.value = formatThousandDots(value);
            if (selectionStart !== null) {
                inputs.amount.setSelectionRange(selectionStart + (inputs.amount.value.length - originalLength), selectionStart + (inputs.amount.value.length - originalLength));
            }
        });
        
        // Auto-generate QR when pressing ENTER on any input field
        Object.values(inputs).forEach(input => {
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    el.generateQR();
                }
            });
        });

        const validate = () => {
            let valid = true;
            Object.values(errorMessages).forEach(msg => msg.style.display = 'none');
            Object.values(inputs).forEach(input => input.classList.remove('is-invalid'));
            if (!inputs.contract.value.trim()) {
                errorMessages.contract.textContent = "Số hợp đồng không được để trống.";
                errorMessages.contract.style.display = "block";
                inputs.contract.classList.add("is-invalid");
                valid = false;
            }
            if (!digitsOnly(inputs.amount.value)) {
                errorMessages.amount.textContent = "Số tiền không được để trống.";
                errorMessages.amount.style.display = "block";
                inputs.amount.classList.add("is-invalid");
                valid = false;
            }
            
            // Cảnh báo nếu số hợp đồng đã tồn tại (từ file PDF đã upload)
            const contractId = inputs.contract.value.trim();
            if (contractId && contractDataStore.has(contractId)) {
                console.log(`ℹ️ Số hợp đồng ${contractId} đã có dữ liệu từ file PDF`);
            }
            
            return valid;
        }
        
        // Function to generate QR for this row
        el.generateQR = () => {
            if (!validate()) return false;
            const data = { contract: inputs.contract.value, name: inputs.name.value, amount: inputs.amount.value };
            const qrUrl = buildQRUrl(data, "qr_only.png");
            const qrUrlHQ = buildQRUrl(data, "qr_only.png");
            
            img.src = qrUrl;
            img.style.display = "block";
            qrDisplay.classList.add("has-qr");
            
            // Setup action buttons
            downloadBtn.href = qrUrlHQ;
            downloadBtn.download = `QR_${data.contract}.png`;
            
            shareBtn.onclick = () => copyToClipboard(buildShareLink(data), "Đã sao chép link chia sẻ!");
            
            const contractId = data.contract;
            const fileSet = contractFilesStore.get(contractId);
            if (fileSet && fileSet.thanhToan) {
                printBtn.onclick = () => window.open(fileSet.thanhToan.url, '_blank');
            } else {
                printBtn.onclick = () => showToast("Vui lòng tải file PDF hợp đồng trước khi in.", "error");
            }
            
            return true;
        };
        
        // Function to delete this row (CHỈ xóa UI, KHÔNG xóa dữ liệu stores)
        el.deleteRow = () => {
            // Chỉ xóa dòng QR trên UI
            // KHÔNG xóa contractDataStore và contractFilesStore
            // để giữ dữ liệu cho tab "In Hợp Đồng"
            el.remove();
            updatePlaceholders();
        };
        
        // Context menu for deletion
        el.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            const contextMenu = document.getElementById("contextMenu");
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.classList.add("show");
            
            // Store reference to the row
            contextMenu.dataset.targetRow = el.dataset.rowId || Date.now();
            el.dataset.rowId = contextMenu.dataset.targetRow;
            
            // Hiển thị lại tùy chọn xóa khi click vào row
            const deleteOption = document.getElementById("deleteRowContextMenu");
            deleteOption.style.display = 'flex';
        });

        img.addEventListener("click", () => {
            if (!img.src) return;
            lbImg.src = buildQRUrl({ contract: inputs.contract.value, name: inputs.name.value, amount: inputs.amount.value }, "qr_only.png");
            lb.classList.add("show");
            
            const data = { contract: inputs.contract.value, name: inputs.name.value, amount: inputs.amount.value };
            downloadQrBtn.href = lbImg.src;
            downloadQrBtn.download = `QR_${data.contract}.png`;

            const contractId = data.contract;
            const fileSet = contractFilesStore.get(contractId);
            printQrBtn.style.display = fileSet ? 'inline-flex' : 'none';
            if (fileSet) {
                 printQrBtn.onclick = () => window.open(fileSet.thanhToan.url, '_blank');
            }

            shareBtn.onclick = () => copyToClipboard(buildShareLink(data), "Đã sao chép link chia sẻ!");
        });

        rowsEl.prepend(node);
        if (isManual) inputs.contract.focus();
        updatePlaceholders();
        return el;
    }

    async function combinePdfsForPrinting(contractId, printType) {
        const btn = document.querySelector(`.contract-files-container[data-contract-id="${contractId}"] .print-${printType}-btn`);
        
        if (!btn) {
            console.error(`Không tìm thấy nút in cho hợp đồng ${contractId}`);
            showToast('Lỗi: Không tìm thấy nút in. Vui lòng thử lại.', 'error');
            return;
        }
        
        const originalBtnHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin me-2"></i> Đang xử lý...`;

        try {
            const fileSet = contractFilesStore.get(contractId);
            if (!fileSet) {
                console.error(`contractFilesStore không chứa dữ liệu cho hợp đồng: ${contractId}`);
                console.log('Các contract ID có trong store:', Array.from(contractFilesStore.keys()));
                throw new Error(`Không tìm thấy dữ liệu file cho hợp đồng ${contractId}. Vui lòng tải lại file PDF hợp đồng.`);
            }

            const finalPdfDoc = await PDFDocument.create();

            // Define the new printing order and pages
            const printConfigurations = {
                front: [
                    { fileKey: 'pdk', pages: [0] },          // trang 1 PDK 0%
                    { fileKey: 'thanhToan', pages: [0] },     // trang thông tin thanh toán
                    { fileKey: 'hopDong', pages: [0] },      // trang 1 hợp đồng tín dụng
                    { fileKey: 'hopDong', pages: [2] },      // trang 3 hợp đồng
                    { fileKey: 'baoHiem', pages: [0] }      // trang 1 bảo hiểm
                ],
                back: [
                    { fileKey: 'baoHiem', pages: [1] },       // trang 2 bảo hiểm
                    { fileKey: 'hopDong', pages: [3] },      // trang 4 hợp đồng
                    { fileKey: 'hopDong', pages: [1] }       // trang 2 hợp đồng
                ]
            };

            const filesToProcess = printConfigurations[printType];

            for (const item of filesToProcess) {
                const { fileKey, pages } = item;
                if (fileSet[fileKey] && fileSet[fileKey].url) {
                     try {
                        const fileUrl = fileSet[fileKey].url;
                        const existingPdfBytes = await fetch(fileUrl).then(res => res.arrayBuffer());
                        const pdfToCopy = await PDFDocument.load(existingPdfBytes);
                        
                        const validPageIndices = pages.filter(index => index < pdfToCopy.getPageCount());
                        if(validPageIndices.length === 0) continue;

                        const copiedPages = await finalPdfDoc.copyPages(pdfToCopy, validPageIndices);
                        copiedPages.forEach(page => finalPdfDoc.addPage(page));
                     } catch (loadErr) {
                         console.warn(`Could not process file part '${fileKey}'. Skipping.`, loadErr);
                     }
                }
            }
            
            if (finalPdfDoc.getPageCount() === 0) {
                throw new Error('Không có trang nào hợp lệ để tạo file in.');
            }

            const finalPdfBytes = await finalPdfDoc.save();
            const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');

        } catch (error) {
            console.error(`Lỗi khi tạo file in (${printType}):`, error);
            showToast(`Lỗi tạo file in: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnHtml;
        }
    }

    // --- Helper & Utility Functions ---
    function buildQRUrl({ contract, name, amount }, template = "qr_only.png") {
        const addInfo = `${contract} ${stripVietnamese(name)}`.trim().toUpperCase();
        return `https://img.vietqr.io/image/970437-002704070014601-${template}?${new URLSearchParams({
            accountName: "HD SAISON", amount: digitsOnly(amount), addInfo, template
        })}`;
    }
    
    function closeLb() { lb.classList.remove("show"); }
    lb.addEventListener("click", (e) => e.target === lb && closeLb());
    lbClose.addEventListener("click", closeLb);
    document.addEventListener("keydown", (e) => e.key === "Escape" && closeLb());

    function buildShareLink(data) {
        const url = new URL(window.location.href.split('?')[0]);
        url.searchParams.set('c', data.contract);
        url.searchParams.set('n', data.name);
        url.searchParams.set('a', data.amount);
        return url.toString();
    }

    function handleSharedLink() {
        const params = new URLSearchParams(window.location.search);
        const contract = params.get('c'), name = params.get('n'), amount = params.get('a');

        if (contract && amount) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('footer').style.display = 'none';
            document.getElementById('viewer').style.display = 'block';

            document.getElementById('viewerImg').src = buildQRUrl({ contract, name, amount }, "qr_only.png");
            document.getElementById('viewerContract').textContent = contract;
            document.getElementById('viewerName').textContent = name || 'N/A';
            document.getElementById('viewerAmount').textContent = `${formatThousandDots(amount)} VND`;
            document.getElementById('viewerDownloadBtn').onclick = () => {
                const a = document.createElement('a');
                a.href = document.getElementById('viewerImg').src;
                a.download = `QR_${contract}.png`;
                a.click();
            };
        }
    }
    
    function showToast(message, type = 'error') {
        const toastEl = document.getElementById('toast');
        toastEl.textContent = message;
        toastEl.className = 'toast-notification'; // Reset classes
        if (type === 'info') toastEl.classList.add('info');
        if (type === 'warning') toastEl.classList.add('warning');
        
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 3500);
    }
    
    function copyToClipboard(text, message) {
        navigator.clipboard.writeText(text)
            .then(() => showToast(message, 'info'))
            .catch(err => showToast('Lỗi khi sao chép.'));
    }
    
    // --- Loan Calculator ED ---
    function calculateLoanEd() {
        const productPrice = parseNumber(document.getElementById('product-price').value);
        const downPayment = parseNumber(document.getElementById('down-payment').value);
        const loanAmountInput = document.getElementById('loan-amount');
        let loanAmount = (productPrice > 0 && productPrice >= downPayment) ? productPrice - downPayment : 0;
        loanAmountInput.value = loanAmount > 0 ? formatCurrency(loanAmount) : "";
        
        const loanTerm = parseInt(document.getElementById('loan-term').value, 10);
        const loanProgramValue = document.getElementById('loan-program').value;
        const includeInsurance = document.getElementById('include-insurance').checked;

        let monthlyInstallment = 0, totalDifference = 0, totalPriceWithFees = 0, monthlyDifference = 0;

        if (loanAmount > 0 && loanTerm > 0) {
            const totalInsurance = includeInsurance ? loanAmount * 0.05 : 0;
            const monthlyInsurance = totalInsurance / loanTerm;

            if (loanProgramValue === 'regular') {
                const coefficients = { '7': 0.175, '9': 0.1393, '12': 0.11135, '15': 0.0947 };
                const coefficient = coefficients[loanTerm];
                if (coefficient) {
                    const basePaymentWithInsurance = loanAmount * coefficient;
                    const basePayment = includeInsurance ? basePaymentWithInsurance - monthlyInsurance : basePaymentWithInsurance;
                    monthlyInstallment = basePayment + monthlyInsurance + 13000;
                    totalDifference = (monthlyInstallment * loanTerm) - loanAmount;
                }
            } else {
                const interestRate = parseFloat(loanProgramValue);
                let totalInterest = 0;
                
                // Công thức chính xác cho lãi suất 0.5%
                if (interestRate === 0.005) {
                    const interestCoefficients = {
                        '6': 0.0322,
                        '9': 0.0486,
                        '12': 0.065,
                        '15': 0.0815,
                        '18': 0.0981,
                        '24': 0.1314
                    };
                    totalInterest = interestCoefficients[loanTerm] ? loanAmount * interestCoefficients[loanTerm] : loanAmount * interestRate * loanTerm;
                } else {
                    // Công thức cho các lãi suất khác (0%, 1%, etc.)
                    totalInterest = loanAmount * interestRate * loanTerm;
                }
                
                const totalCollectionFee = 12000 * loanTerm;
                totalDifference = totalInsurance + totalInterest + totalCollectionFee;
                monthlyInstallment = (loanAmount + totalDifference) / loanTerm;
            }
            totalPriceWithFees = productPrice + totalDifference;
            monthlyDifference = totalDifference / loanTerm;
        }

        const formatMonthly = num => num > 0 ? (Math.ceil(num / 1000) * 1000).toLocaleString('vi-VN') + ' VNĐ' : (loanAmount > 0 ? "Không áp dụng" : "");
        document.getElementById('monthly-installment').value = formatMonthly(monthlyInstallment);
        document.getElementById('total-difference').value = loanAmount > 0 ? formatCurrency(totalDifference) : "";
        document.getElementById('total-price-with-fees').value = loanAmount > 0 ? formatCurrency(totalPriceWithFees) : "";
        document.getElementById('monthly-difference').value = loanAmount > 0 ? formatCurrency(Math.round(monthlyDifference / 100) * 100) : "";
    }
    
    function formatCurrencyOnLoanInput(event) {
        const { target: input } = event;
        const { value, selectionStart } = input;
        const numericValue = parseNumber(value);
        const formattedValue = numericValue > 0 ? numericValue.toLocaleString('vi-VN') : '';
        input.value = formattedValue;
        input.setSelectionRange(selectionStart + (formattedValue.length - value.length), selectionStart + (formattedValue.length - value.length));
        calculateLoanEd();
    }

    function resetEdForm() {
        ['product-price', 'down-payment-percentage', 'down-payment'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('loan-term').value = '6';
        document.getElementById('include-insurance').checked = true;
        document.getElementById('product-price').focus();
        calculateLoanEd();
    }

    // Advisor info realtime update functionality
    let advisorUpdateTimeout;
    let advisorUpdateInProgress = false;

    function initAdvisorRealtimeUpdate() {
        const advisorNameInput = document.getElementById('advisor-name');
        const advisorPhoneInput = document.getElementById('advisor-phone');
        
        if (!advisorNameInput || !advisorPhoneInput) return;

        // Function to handle advisor info update
        const updateAdvisorInfo = () => {
            if (advisorUpdateInProgress) return;
            
            // Add visual feedback
            advisorNameInput.classList.add('updating');
            advisorPhoneInput.classList.add('updating');
            
            clearTimeout(advisorUpdateTimeout);
            advisorUpdateTimeout = setTimeout(async () => {
                await processAdvisorUpdate();
                // Remove visual feedback
                advisorNameInput.classList.remove('updating');
                advisorPhoneInput.classList.remove('updating');
            }, 1000);
        };

        // Add event listeners for both inputs
        advisorNameInput.addEventListener('input', updateAdvisorInfo);
        advisorPhoneInput.addEventListener('input', updateAdvisorInfo);
        
        // Handle Enter key
        [advisorNameInput, advisorPhoneInput].forEach(input => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(advisorUpdateTimeout);
                    processAdvisorUpdate();
                    e.target.blur();
                }
            });
        });
    }

    async function processAdvisorUpdate() {
        if (advisorUpdateInProgress) return;
        
        advisorUpdateInProgress = true;
        const advisorNameInput = document.getElementById('advisor-name');
        const advisorPhoneInput = document.getElementById('advisor-phone');
        
        try {
            // Get current advisor info
            const advisorName = advisorNameInput?.value?.trim() || '';
            const advisorPhone = advisorPhoneInput?.value?.trim() || '';
            
            console.log(`Updating advisor info: ${advisorName || 'N/A'} - ${advisorPhone || 'N/A'}`);
            
            // Update all existing contracts with new advisor info
            for (const [contractId, contractData] of contractDataStore.entries()) {
                // Update advisor info in contract data
                contractData.advisorName = advisorName;
                contractData.advisorPhone = advisorPhone;
                contractDataStore.set(contractId, contractData);
                
                // Regenerate payment PDF with advisor info
                await regeneratePaymentPdfWithAdvisor(contractId);
            }
            
            // Show success feedback
            if (advisorName || advisorPhone) {
                showToast('Đã cập nhật thông tin nhân viên tư vấn', 'success');
            }
        } catch (error) {
            console.error('Lỗi khi cập nhật advisor info:', error);
            showToast('Lỗi khi cập nhật thông tin nhân viên tư vấn', 'error');
        } finally {
            advisorUpdateInProgress = false;
        }
    }

    async function regeneratePaymentPdfWithAdvisor(contractId) {
        try {
            const contractData = contractDataStore.get(contractId);
            const fileSet = contractFilesStore.get(contractId);
            
            if (!contractData || !fileSet) {
                console.log(`Không tìm thấy dữ liệu cho hợp đồng ${contractId}`);
                return;
            }

            // Get original PDF data
            const originalPdfDoc = contractData.originalPdfDoc;
            const paymentPage = contractData.paymentPage;
            
            if (!originalPdfDoc || !paymentPage) {
                console.log(`Thiếu dữ liệu PDF gốc cho hợp đồng ${contractId}`);
                return;
            }

            console.log(`Regenerating payment PDF for contract ${contractId} with advisor info`);
            
            // Revoke old payment PDF URL
            if (fileSet.thanhToan?.url) {
                URL.revokeObjectURL(fileSet.thanhToan.url);
            }

            // Create new payment PDF with advisor info
            const thanhToanDoc = await PDFDocument.create();
            const [thanhToanPage] = await thanhToanDoc.copyPages(originalPdfDoc, [paymentPage - 1]);
            thanhToanDoc.addPage(thanhToanPage);
            
            // Fetch QR image
            const { imageBytes: qrImageBytes, template: usedTemplate, isPNG, isJPEG } = await fetchQRImage(contractData.qrData);
            
            // Embed QR image
            let qrImage;
            if (isPNG) {
                qrImage = await thanhToanDoc.embedPng(qrImageBytes);
            } else if (isJPEG) {
                qrImage = await thanhToanDoc.embedJpg(qrImageBytes);
            } else {
                throw new Error("Không thể xác định định dạng QR image");
            }
            
            const { width, height } = thanhToanPage.getSize();
            const qrDims = qrImage.scale(0.20);
            thanhToanPage.drawImage(qrImage, { 
                x: width - qrDims.width - 65, 
                y: height - qrDims.height - 65, 
                width: qrDims.width, 
                height: qrDims.height 
            });
            
            // Add advisor info if available
            const advisorName = contractData.advisorName;
            const advisorPhone = contractData.advisorPhone;
            
            if (advisorName || advisorPhone) {
                // Register fontkit
                thanhToanDoc.registerFontkit(fontkit);
                
                // Get font resources
                const selectedPos = document.getElementById('pos-select')?.value;
                const { fontBytes } = await getRequiredResources(selectedPos);
                const advisorFont = await thanhToanDoc.embedFont(fontBytes, { subset: false });
                
                // Calculate box dimensions
                const fontSize = 9;
                const padding = 6;
                const lineHeight = fontSize + 2;
                
                let maxTextWidth = 0;
                if (advisorName) {
                    const nameWidth = advisorFont.widthOfTextAtSize(advisorName.toUpperCase(), fontSize);
                    maxTextWidth = Math.max(maxTextWidth, nameWidth);
                }
                if (advisorPhone) {
                    const phoneWidth = advisorFont.widthOfTextAtSize(advisorPhone, fontSize);
                    maxTextWidth = Math.max(maxTextWidth, phoneWidth);
                }
                
                const boxWidth = Math.max(80, maxTextWidth + (padding * 2));
                const boxHeight = (advisorName && advisorPhone) ? 32 : 18;
                
                // Position advisor box
                const qrX = width - qrDims.width - 65;
                const marginFromQR = 15;
                const advisorX = qrX - boxWidth - marginFromQR;
                const advisorY = height - qrDims.height - 45;
                
                // Draw advisor info box
                thanhToanPage.drawRectangle({
                    x: advisorX,
                    y: advisorY - boxHeight + padding,
                    width: boxWidth,
                    height: boxHeight,
                    borderColor: rgb(0, 0, 0),
                    borderWidth: 1.5,
                    color: rgb(1, 1, 1),
                });
                
                let currentY = advisorY - padding - 2;
                
                // Draw advisor name
                if (advisorName) {
                    const nameText = advisorName.toUpperCase();
                    const nameX = advisorX + padding;
                    
                    thanhToanPage.drawText(nameText, {
                        x: nameX,
                        y: currentY,
                        size: fontSize,
                        font: advisorFont,
                        color: rgb(0, 0, 0)
                    });
                    currentY -= lineHeight;
                    
                    // Draw separator line if both name and phone exist
                    if (advisorPhone) {
                        const separatorY = currentY + 4;
                        thanhToanPage.drawLine({
                            start: { x: advisorX + 2, y: separatorY },
                            end: { x: advisorX + boxWidth - 2, y: separatorY },
                            thickness: 0.8,
                            color: rgb(0.3, 0.3, 0.3),
                        });
                    }
                }
                
                // Draw advisor phone
                if (advisorPhone) {
                    const phoneText = advisorPhone;
                    const phoneX = advisorX + padding;
                    const phoneYOffset = 5;
                    const phoneY = currentY - phoneYOffset;
                    
                    thanhToanPage.drawText(phoneText, {
                        x: phoneX,
                        y: phoneY,
                        size: fontSize,
                        font: advisorFont,
                        color: rgb(0, 0, 0)
                    });
                }
            }
            
            // Save updated PDF
            const thanhToanBytes = await thanhToanDoc.save();
            const pdkData = contractData.pdkData || contractData; // Handle both structures
            const contractShd = pdkData.shd || contractData.qrData?.contract || 'Unknown';
            fileSet.thanhToan = { 
                url: URL.createObjectURL(new Blob([thanhToanBytes], { type: 'application/pdf' })), 
                name: `HuongDanThanhToan_${contractShd}.pdf` 
            };
            
            // Update file set
            contractFilesStore.set(contractId, fileSet);
            
            // Update UI links with new PDF
            updatePaymentPdfLinksInUI(contractId, fileSet.thanhToan);
            console.log(`Đã cập nhật PDF thanh toán cho hợp đồng ${contractId}`, {
                newUrl: fileSet.thanhToan.url,
                fileName: fileSet.thanhToan.name
            });
            
        } catch (error) {
            console.error(`Lỗi khi tạo lại PDF thanh toán cho hợp đồng ${contractId}:`, error);
        }
    }

    function updatePaymentPdfLinksInUI(contractId, paymentFileInfo) {
        try {
            // Find the contract container in UI
            const contractContainer = document.querySelector(`[data-contract-id="${contractId}"]`);
            if (!contractContainer) {
                console.log(`Không tìm thấy container UI cho hợp đồng ${contractId}`);
                return;
            }

            // Find all payment PDF links (thanhToan file type)
            const paymentFileItem = contractContainer.querySelector('[data-file-type="thanhToan"]');
            if (!paymentFileItem) {
                console.log(`Không tìm thấy payment file item cho hợp đồng ${contractId}`);
                return;
            }

            // Update all links in the payment file item
            const links = paymentFileItem.querySelectorAll('a[href]');
            links.forEach(link => {
                if (link.href && link.href.startsWith('blob:')) {
                    // Revoke old blob URL
                    URL.revokeObjectURL(link.href);
                }
                
                // Update href with new URL
                link.href = paymentFileInfo.url;
                
                // Update download attribute if it exists
                if (link.hasAttribute('download')) {
                    link.setAttribute('download', paymentFileInfo.name);
                }
            });

            console.log(`Đã cập nhật ${links.length} link(s) cho file thanh toán của hợp đồng ${contractId}`);
        } catch (error) {
            console.error(`Lỗi khi cập nhật UI links cho hợp đồng ${contractId}:`, error);
        }
    }

    // Initialize advisor realtime update when page loads
    document.addEventListener('DOMContentLoaded', () => {
        initAdvisorRealtimeUpdate();
    });
    
  </script>
</body>
</html>

