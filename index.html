<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>VietQR - HD SAISON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Meta tags for social sharing -->
  <meta property="og:title" content="Tạo mã VietQR HD SAISON" />
  <meta property="og:description" content="Công cụ tạo mã VietQR cho hợp đồng HD SAISON nhanh chóng và tiện lợi. Hỗ trợ tải file PDF để tự động điền thông tin và in ấn." />
  <meta property="og:image" content="https://flic.kr/p/2rmRvBZ" />
  <meta property="og:type" content="website" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <!-- Thêm thư viện PDF.js và pdf-lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#15253b; --muted:#6b7280;
      --border:#e9eef5; --shadow:0 10px 30px rgba(25,35,78,.08); --danger:#dc3545; --info: #0dcaf0;
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
      --border:#263143; --shadow:0 10px 30px rgba(0,0,0,.5); --danger:#f87171;
    }
    body{ background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app-card{ background:var(--card); border:none; border-radius:16px; box-shadow:var(--shadow); padding:24px; }
    .soft-panel{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .title{ font-weight:800; letter-spacing:.2px; color:var(--ink); }
    .hdr { color:var(--muted); font-weight:700; text-transform:uppercase; font-size:.78rem; letter-spacing:.04em }
    .row-item{ background:var(--card); border:1px solid var(--border); border-radius:14px; margin-bottom:12px; padding: 12px; }
    
    .row-line{ display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .field-wrapper { flex: 1 1 180px; }
    .actions-group { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; margin-top: auto; }

    .row-item .form-control, .soft-panel .form-control { border-radius:12px; background:var(--card); color:var(--ink); border-color:var(--border); }
    .row-item .form-control::placeholder, .soft-panel .form-control::placeholder { color:var(--muted); }
    .row-item .form-control.is-invalid { border-color: var(--danger); }
    .row-item .form-control:focus, .soft-panel .form-control:focus { box-shadow: none; border-color: var(--border); }
    .row-item .btn{ border-radius:12px; white-space:nowrap; }
    .qr-thumb{ width:84px; height:84px; border-radius:12px; object-fit:contain; display:none; cursor:zoom-in; border:1px solid var(--border); background:#fff; }

    .error-msg { color: var(--danger); font-size: 0.8rem; margin-top: 4px; display: none; }

    .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; padding:18px; opacity:0; pointer-events:none; transition:opacity .2s ease-out; z-index:9999; }
    .lightbox.show{ opacity:1; pointer-events:auto; }
    .lightbox-inner{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px; transform:scale(.92); transition:transform .2s ease-out; max-width:min(520px, 92vw); }
    .lightbox.show .lightbox-inner{ transform:scale(1); }
    .lightbox img{ width:100%; height:auto; display:block; border-radius:10px; }
    .lightbox .close{ position:absolute; top:14px; right:14px; border:0; background:#111827; color:#fff; border-radius:10px; padding:.35rem .7rem; font-weight:700; cursor:pointer; z-index: 10;}
    .lightbox .download-qr{ position:absolute; top:14px; right:60px; border:0; background:#111827; color:#fff; border-radius:10px; padding:.35rem .7rem; font-weight:700; cursor:pointer; text-decoration: none;}
    
    .toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--danger); color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none; }
    .toast-notification.show { top: 30px; opacity: 1; }
    .toast-notification.info { background-color: var(--info); color: var(--ink); }

    .instructions .list-group-item { background: transparent; border-color: var(--border); color: var(--ink); font-size: 0.85rem; }
    .instructions .fa-solid { color: var(--info); }
    #instructionsContent.show { display: block !important; }
  </style>
</head>
<body>
  <div class="container py-4" id="root">
    <div class="app-card mx-auto" style="max-width:1100px">
      <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
        <h3 class="title mb-0">Tạo mã VietQR HD SAISON</h3>
        <div class="d-flex align-items-center gap-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="darkSwitch">
            <label class="form-check-label" for="darkSwitch">Dark mode</label>
          </div>
          <label for="pdfFile" class="btn btn-secondary px-3" id="uploadPdfLabel">
              <i class="fa-solid fa-file-pdf"></i> Tải PDF
          </label>
          <input type="file" id="pdfFile" accept=".pdf" class="d-none" multiple />
          <button id="addRow" class="btn btn-success px-3">+ Thêm hợp đồng</button>
        </div>
      </div>

      <div class="soft-panel mb-4 instructions">
        <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" id="toggleInstructionsBtn">
            <h5 class="hdr mb-0">Hướng dẫn sử dụng</h5>
            <button class="btn btn-sm btn-outline-secondary">
                <i class="fa-solid fa-chevron-down"></i>
            </button>
        </div>
        <div id="instructionsContent" class="d-none mt-2">
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex align-items-start"><i class="fa-solid fa-file-pdf fa-fw mt-1 me-3"></i><div><strong>Tải PDF (Nhanh):</strong> Nhấn nút "Tải PDF" và chọn 1 hoặc nhiều file (tối đa 10). Thông tin sẽ được tự động điền vào các dòng và tạo mã QR tương ứng.</div></li>
                <li class="list-group-item d-flex align-items-start"><i class="fa-solid fa-keyboard fa-fw mt-1 me-3"></i><div><strong>Nhập thủ công:</strong> Nhấn "+ Thêm hợp đồng" để tạo dòng mới, sau đó điền thông tin và nhấn "Tạo QR".</div></li>
                <li class="list-group-item d-flex align-items-start"><i class="fa-solid fa-print fa-fw mt-1 me-3"></i><div><strong>In Hợp Đồng & QR:</strong> Với dòng được tạo từ PDF, nhấn nút <i class="fa-solid fa-print"></i> để mở tab mới chứa file PDF đã được chèn sẵn mã QR để in.</div></li>
                <li class="list-group-item d-flex align-items-start"><i class="fa-solid fa-images fa-fw mt-1 me-3"></i><div><strong>In QR lẻ:</strong> Với dòng nhập tay (không có file PDF), nút <i class="fa-solid fa-print"></i> sẽ mở trang để in mã QR.</div></li>
            </ul>
        </div>
      </div>
      
      <div id="toast" class="toast-notification"></div>

      <div class="d-none d-md-flex align-items-center justify-content-between px-3 mb-2">
        <div class="d-flex align-items-center gap-2" style="flex-grow: 1;">
          <div class="hdr" style="flex: 1 1 230px;">Số hợp đồng</div>
          <div class="hdr" style="flex: 1 1 260px;">Họ tên</div>
          <div class="hdr" style="flex: 1 1 170px;">Số tiền (VND)</div>
        </div>
        <div style="width: 180px;"> <!-- Placeholder for alignment -->
        </div>
      </div>

      <div id="rows"></div>
    </div>
  </div>

  <div id="lb" class="lightbox" aria-hidden="true">
    <div class="lightbox-inner position-relative">
      <a href="#" class="download-qr" download title="Tải ảnh QR"><i class="fa-solid fa-download"></i></a>
      <button class="close" type="button" id="lbClose" aria-label="Đóng">×</button>
      <img id="lbImg" alt="VietQR phóng to"/>
    </div>
  </div>

  <template id="rowTemplate">
    <div class="row-item">
      <div class="row-line">
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Số hợp đồng</label>
            <input class="form-control contractInput" placeholder="VD: ED01234567"/>
            <div class="error-msg"></div>
        </div>
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Họ tên</label>
            <input class="form-control nameInput" placeholder="VD: Nguyễn Văn A"/>
            <div class="error-msg"></div>
        </div>
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Số tiền (VND)</label>
            <input class="form-control amountInput" inputmode="numeric" placeholder="VD: 1.000.000"/>
            <div class="error-msg"></div>
        </div>
        <div class="actions-group">
            <button class="btn btn-primary generateBtn">Tạo QR</button>
            <button class="btn btn-success printBtn" disabled title="In hợp đồng có QR"><i class="fa-solid fa-print"></i></button>
            <img class="qr-thumb" alt="QR preview" title="Click để phóng to"/>
            <button class="btn btn-outline-danger deleteRowBtn" title="Xoá dòng"><i class="fa-solid fa-trash-can"></i></button>
        </div>
      </div>
    </div>
  </template>
  
  <footer class="text-center py-4">
    <p class="mb-0" style="font-size: 0.8rem; color: var(--muted);">Phát triển bởi Huỳnh Hải Đăng</p>
  </footer>

  <script>
    const { PDFDocument, rgb } = PDFLib;

    const BANK_ID      = "hdbank";
    const ACCOUNT_NO   = "002704070014601";
    const ACCOUNT_NAME = "HD SAISON";
    const TEMPLATE     = "print.png";
    const QR_TEMPLATE_EMBED = "compact.png";
    const LOGO_URL     = "https://i.imgur.com/sC5323R.png";

    const rowsEl   = document.getElementById("rows");
    const addRowEl = document.getElementById("addRow");
    const tpl      = document.getElementById("rowTemplate");
    const toastEl  = document.getElementById("toast");
    const pdfFileInput = document.getElementById('pdfFile');
    const uploadPdfLabel = document.getElementById('uploadPdfLabel');
    const toggleInstructionsBtn = document.getElementById('toggleInstructionsBtn');
    const instructionsContent = document.getElementById('instructionsContent');

    const lb      = document.getElementById("lb");
    const lbImg   = document.getElementById("lbImg");
    const lbClose = document.getElementById("lbClose");
    const lbDownload = document.querySelector('.download-qr');
    const darkSwitch = document.getElementById("darkSwitch");
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

    const pdfBuffers = new Map();

    (function initTheme(){
      const saved = localStorage.getItem("theme");
      if(saved === "dark"){ document.documentElement.setAttribute("data-theme","dark"); darkSwitch.checked = true; }
      darkSwitch.addEventListener("change", ()=>{
        const mode = darkSwitch.checked ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", mode);
        localStorage.setItem("theme", mode);
      });
    })();

    function showToast(message, type = 'error') {
        toastEl.textContent = message;
        toastEl.className = 'toast-notification';
        if (type === 'info') toastEl.classList.add('info');
        toastEl.classList.add("show");
        setTimeout(() => { toastEl.classList.remove("show"); }, 3000);
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayYYYYMMDD(){ const d=new Date(); return d.getFullYear()+""+pad2(d.getMonth()+1)+""+pad2(d.getDate()); }
    function digitsOnly(str){ return (str||"").replace(/\D/g,""); }
    function formatThousandDots(numStr){ const s = digitsOnly(numStr); return s.replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function stripVietnamese(str){
      if(!str) return "";
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/đ/gi,"d")
               .replace(/[^A-Za-z0-9 ]+/g," ").replace(/\s+/g," ").trim();
    }

    function buildQRUrl({contract, name, amount}, template = TEMPLATE){
      const amountDigits = digitsOnly(amount);
      const addInfo = `${contract} ${stripVietnamese(name)}`.trim().toUpperCase();
      const qs = new URLSearchParams({ 
          amount: String(parseInt(amountDigits,10)||0), 
          addInfo, 
          accountName: ACCOUNT_NAME,
          logo: LOGO_URL
      });
      // Thêm tham số ngẫu nhiên để trình duyệt không lưu cache ảnh QR
      qs.append('cache_bust', Date.now());
      return `https://img.vietqr.io/image/${BANK_ID}-${ACCOUNT_NO}-${template}?${qs.toString()}`;
    }

    async function createAndPrintModifiedPdf(pdfBuffer, qrUrl) {
        // Mở cửa sổ mới ngay lập tức để tránh bị chặn popup
        const printWindow = window.open("", "_blank");
        if (!printWindow) {
            showToast("Trình duyệt đã chặn popup. Vui lòng cho phép.");
            return;
        }
        printWindow.document.write('<!DOCTYPE html><html lang="vi"><head><title>Đang tạo PDF...</title><style>body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-size:1.2rem;color:#333;}</style></head><body><p>⏳ Đang chuẩn bị file PDF, vui lòng chờ trong giây lát...</p></body></html>');

        try {
            const qrImageResponse = await fetch(qrUrl, { cache: 'no-store' });
            if (!qrImageResponse.ok) throw new Error('Không thể tải ảnh QR');
            const qrImageBytes = await qrImageResponse.arrayBuffer();

            const pdfDoc = await PDFDocument.load(pdfBuffer);
            const qrImage = await pdfDoc.embedPng(qrImageBytes);
            
            const firstPage = pdfDoc.getPages()[0];
            
            // Chèn ảnh QR
            const qrSize = 170; 
            firstPage.drawImage(qrImage, {
                x: 390,
                y: 680, 
                width: qrSize,
                height: qrSize,
            });

            const modifiedPdfBytes = await pdfDoc.save();
            const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);

            // Tải nội dung vào cửa sổ đã mở
            printWindow.location.href = url;

        } catch (error) {
            console.error("Lỗi khi tạo PDF:", error);
            showToast("Không thể tạo file PDF để in.");
            printWindow.close(); // Đóng cửa sổ nếu có lỗi
        }
    }

    function openQrPrintPreview(qrUrl) {
        const w = window.open("", "_blank");
        if (!w) { showToast("Trình duyệt đã chặn popup."); return; }
        const html = `
            <!DOCTYPE html><html lang="vi"><head><meta charset="utf-8"/><title>In mã QR</title>
            <style>
                body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
                img { max-width: 80vw; max-height: 80vh; object-fit: contain; }
                @media print { 
                    @page { size: A5 landscape; margin: 0; }
                    body { margin: 0; padding: 0; justify-content: center; align-items: center; }
                    img { width: 100%; height: 100%; object-fit: contain; }
                }
            </style></head>
            <body><img src="${qrUrl}" alt="VietQR"/><script> window.onload = () => { setTimeout(() => { window.print(); }, 500); }; <\/script></body></html>`;
        w.document.open(); w.document.write(html); w.document.close();
    }

    function addRow(){
      const node = tpl.content.cloneNode(true);
      const el = node.querySelector(".row-item");
      const inputContract = el.querySelector(".contractInput");
      const inputName = el.querySelector(".nameInput");
      const inputAmount = el.querySelector(".amountInput");
      const btnGen = el.querySelector(".generateBtn");
      const btnPrint = el.querySelector(".printBtn");
      const btnDelRow = el.querySelector(".deleteRowBtn");
      const img = el.querySelector(".qr-thumb");

      [inputContract, inputName, inputAmount].forEach(input => {
        input.addEventListener('input', () => {
            input.classList.remove('is-invalid');
            input.closest('.field-wrapper').querySelector('.error-msg').style.display = 'none';
        });
      });

      inputAmount.addEventListener("input", ()=>{
        const caretEnd = inputAmount.selectionEnd;
        const beforeLen = inputAmount.value.length;
        inputAmount.value = formatThousandDots(inputAmount.value);
        const afterLen = inputAmount.value.length;
        inputAmount.selectionStart = inputAmount.selectionEnd = Math.max(0, caretEnd + (afterLen - beforeLen));
      });

      function validate(){
        let isValid = true;
        el.querySelectorAll('.error-msg').forEach(e => e.style.display = 'none');
        el.querySelectorAll('.form-control').forEach(e => e.classList.remove('is-invalid'));
        const c = inputContract.value.trim().toUpperCase();
        const n = inputName.value.trim();
        const a = inputAmount.value.trim();
        if(!c){
          inputContract.closest('.field-wrapper').querySelector('.error-msg').textContent = "Vui lòng nhập Số Hợp Đồng.";
          inputContract.closest('.field-wrapper').querySelector('.error-msg').style.display = 'block';
          inputContract.classList.add('is-invalid');
          isValid = false;
        }
        if(!n){
          inputName.closest('.field-wrapper').querySelector('.error-msg').textContent = "Vui lòng nhập Họ Tên.";
          inputName.closest('.field-wrapper').querySelector('.error-msg').style.display = 'block';
          inputName.classList.add('is-invalid');
          isValid = false;
        }
        if(!digitsOnly(a) || parseInt(digitsOnly(a), 10) <= 0){
          inputAmount.closest('.field-wrapper').querySelector('.error-msg').textContent = "Vui lòng nhập số tiền hợp lệ.";
          inputAmount.closest('.field-wrapper').querySelector('.error-msg').style.display = 'block';
          inputAmount.classList.add('is-invalid');
          isValid = false;
        }
        if (!isValid) return false;
        return {contract:c, name:n, amount:a};
      }

      btnGen.addEventListener("click", ()=>{
        const v = validate(); if(!v) return;
        const url = buildQRUrl(v);
        img.src = url; img.style.display = "block";
        btnPrint.disabled = false;
      });

      btnPrint.addEventListener("click", async () => {
          const v = validate(); if (!v) return;
          const pdfId = el.dataset.pdfId;
          
          const originalBtnHTML = btnPrint.innerHTML;
          btnPrint.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
          btnPrint.disabled = true;

          try {
            if (pdfId && pdfBuffers.has(pdfId)) {
                const pdfBuffer = pdfBuffers.get(pdfId);
                const qrUrlForEmbed = buildQRUrl(v, QR_TEMPLATE_EMBED);
                await createAndPrintModifiedPdf(pdfBuffer, qrUrlForEmbed);
            } else {
                const qrUrlForPrint = buildQRUrl(v, TEMPLATE);
                openQrPrintPreview(qrUrlForPrint);
            }
          } finally {
            btnPrint.innerHTML = originalBtnHTML;
            btnPrint.disabled = false;
          }
      });
      
      btnDelRow.addEventListener("click", () => {
        const pdfId = el.dataset.pdfId;
        if (pdfId) pdfBuffers.delete(pdfId);
        el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        el.style.opacity = '0';
        el.style.transform = 'scale(0.95)';
        setTimeout(() => el.remove(), 300);
      });

      img.addEventListener("click", ()=>{
        if(!img.src) return;
        lbImg.src = img.src;
        lbDownload.href = img.src;
        lbDownload.download = `${inputContract.value}_${todayYYYYMMDD()}.png`;
        lb.classList.add("show");
        lb.setAttribute("aria-hidden","false");
      });

      rowsEl.appendChild(node);
      inputContract.focus();
      return el;
    }

    function closeLb(){ lb.classList.remove("show"); lb.setAttribute("aria-hidden","true"); lbImg.src=""; }
    lb.addEventListener("click", (e)=>{ if(e.target===lb) closeLb(); });
    lbClose.addEventListener("click", closeLb);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeLb(); });

    addRowEl.addEventListener("click", addRow);

    async function handlePdfUpload(event) {
        const files = event.target.files;
        if (files.length === 0) return;

        if (files.length > 10) {
            showToast('Bạn chỉ có thể tải lên tối đa 10 file cùng lúc.');
            event.target.value = '';
            return;
        }
        
        const originalBtnHTML = uploadPdfLabel.innerHTML;
        uploadPdfLabel.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...`;
        uploadPdfLabel.classList.add('disabled');

        let isFirstFileInBatch = true;
        let successCount = 0;

        for (const file of files) {
            if (file.type !== 'application/pdf') {
                showToast(`File "${file.name}" không phải là PDF và đã bị bỏ qua.`);
                continue;
            }
            try {
                const pdfBuffer = await file.arrayBuffer();
                const text = await new Promise((resolve, reject) => {
                    const typedarray = new Uint8Array(pdfBuffer);
                    pdfjsLib.getDocument(typedarray).promise.then(async (pdf) => {
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ');
                        }
                        resolve(fullText);
                    }).catch(reject);
                });
                
                const parsed = parsePdfTextAndFillRow(text, pdfBuffer, isFirstFileInBatch);
                if (parsed) {
                    successCount++;
                    isFirstFileInBatch = false; 
                }

            } catch (error) {
                console.error(`Lỗi xử lý file "${file.name}":`, error);
                showToast(`Không thể xử lý file "${file.name}".`);
            }
        }

        if (successCount > 0) {
            showToast(`Đã xử lý thành công ${successCount} file PDF.`, 'info');
        }

        uploadPdfLabel.innerHTML = originalBtnHTML;
        uploadPdfLabel.classList.remove('disabled');
        event.target.value = '';
    }

    function parsePdfTextAndFillRow(text, pdfBuffer, isFirstFile) {
        const contractRegex = /Số Hợp Đồng:\s*([A-Z0-9]+)/;
        const nameRegex = /Họ tên:\s*(.*?)\s*Thông tin Khoản Vay:/;
        const amountRegex = /Khoản Thanh Toán Hàng Tháng:\s*([\d,.]+)\s*VNĐ/;

        const contractMatch = text.match(contractRegex);
        const nameMatch = text.match(nameRegex);
        const amountMatch = text.match(amountRegex);

        if (contractMatch && nameMatch && amountMatch) {
            const contract = contractMatch[1].trim();
            const name = nameMatch[1].trim();
            const amount = amountMatch[1].trim();
            
            let targetRow = null;
            
            if (isFirstFile) {
                const firstRow = rowsEl.querySelector('.row-item');
                if (firstRow) {
                    const contractInput = firstRow.querySelector('.contractInput');
                    const nameInput = firstRow.querySelector('.nameInput');
                    const amountInput = firstRow.querySelector('.amountInput');
                    if (!contractInput.value && !nameInput.value && !amountInput.value) {
                        targetRow = firstRow;
                    }
                }
            }

            if (!targetRow) {
                targetRow = addRow();
            }

            if (targetRow) {
                const pdfId = Date.now().toString() + Math.random();
                targetRow.dataset.pdfId = pdfId;
                pdfBuffers.set(pdfId, pdfBuffer);

                targetRow.querySelector('.contractInput').value = contract;
                targetRow.querySelector('.nameInput').value = name;
                targetRow.querySelector('.amountInput').value = formatThousandDots(amount);
                
                targetRow.querySelector('.generateBtn').click();
                
                return true;
            }
        } else {
            let errorMsg = 'Không tìm thấy đủ thông tin trong file PDF.';
            if (!nameMatch) errorMsg = 'Không tìm thấy "Họ tên" theo đúng định dạng.';
            else if (!contractMatch) errorMsg = 'Không tìm thấy "Số Hợp Đồng" theo đúng định dạng.';
            else if (!amountMatch) errorMsg = 'Không tìm thấy "Khoản Thanh Toán Hàng Tháng" theo đúng định dạng.';
            showToast(errorMsg);
        }
        return false;
    }

    pdfFileInput.addEventListener('change', handlePdfUpload);

    toggleInstructionsBtn.addEventListener('click', () => {
        instructionsContent.classList.toggle('d-none');
        const icon = toggleInstructionsBtn.querySelector('i');
        icon.classList.toggle('fa-chevron-down');
        icon.classList.toggle('fa-chevron-up');
    });

    addRow();
  </script>
</body>
</html>
