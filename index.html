<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>Bộ công cụ HDSAISON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Meta tags for social sharing -->
  <meta property="og:title" content="Bộ công cụ HDSAISON" />
  <meta property="og:description" content="Công cụ tạo mã VietQR và lọc thông tin khách hàng cho HD SAISON." />
  <meta property="og:image" content="https://i.ibb.co/Pvx3mZ44/images.png" />
  <meta property="og:type" content="website" />

  <link rel="icon" type="image/png" href="https://i.ibb.co/Pvx3mZ44/images.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#15253b; --muted:#6b7280;
      --border:#e9eef5; --shadow:0 10px 30px rgba(25,35,78,.08); --danger:#dc3545; --info: #0dcaf0;
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
      --border:#263143; --shadow:0 10px 30px rgba(0,0,0,.5); --danger:#f87171;
    }
    body{ background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .app-card{ background:var(--card); border:none; border-radius:16px; box-shadow:var(--shadow); padding:24px; }
    .soft-panel{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .title{ font-weight:800; letter-spacing:.2px; color:var(--ink); }
    .hdr { color:var(--muted); font-weight:700; text-transform:uppercase; font-size:.78rem; letter-spacing:.04em }
    .row-item{ background:var(--card); border:1px solid var(--border); border-radius:14px; margin-bottom:12px; padding: 12px; }
    
    .row-line{ display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .field-wrapper { flex: 1 1 180px; }
    .actions-group { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; margin-top: auto; }

    .row-item .form-control, .soft-panel .form-control, .form-select { border-radius:12px; background:var(--card); color:var(--ink); border-color:var(--border); }
    .form-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none !important; }
    [data-theme="dark"] .form-control::placeholder { color: var(--muted) }
    .row-item .form-control::placeholder, .soft-panel .form-control::placeholder { color:var(--muted); }
    .row-item .form-control.is-invalid { border-color: var(--danger); }
    .row-item .form-control:focus, .soft-panel .form-control:focus, .form-select:focus { box-shadow: none; border-color: var(--border); }
    .row-item .btn{ border-radius:12px; white-space:nowrap; }
    .qr-thumb{ width:84px; height:84px; border-radius:12px; object-fit:contain; display:none; cursor:zoom-in; border:1px solid var(--border); background:#fff; }

    .error-msg { color: var(--danger); font-size: 0.8rem; margin-top: 4px; display: none; }

    /* --- Lightbox Styles --- */
    .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; padding:18px; opacity:0; pointer-events:none; transition:opacity .2s ease-out; z-index:9999; }
    .lightbox.show{ opacity:1; pointer-events:auto; }
    .lightbox-inner{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:24px; transform:scale(.92); transition:transform .2s ease-out; max-width:min(520px, 92vw); text-align: center; }
    .lightbox.show .lightbox-inner{ transform:scale(1); }
    .lightbox img{ width:100%; height:auto; display:block; border-radius:10px; margin-bottom: 16px; }
    
    .lightbox-actions { display: flex; justify-content: center; align-items: center; gap: 12px; flex-wrap: wrap; }
    .btn-lightbox {
        border: 0;
        background: #1f2937;
        color: #fff;
        border-radius: 10px;
        padding: .6rem 1rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background .2s;
    }
    [data-theme="dark"] .btn-lightbox { background: #374151; }
    .btn-lightbox:hover { background: #374151; color: #fff; }
    [data-theme="dark"] .btn-lightbox:hover { background: #4b5563; }
    .btn-lightbox.close { background: var(--danger); }
    .btn-lightbox.close:hover { background: var(--danger); opacity: 0.85; }
    .btn-lightbox:disabled { opacity: 0.7; cursor: not-allowed; }
    
    .toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--danger); color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none; }
    .toast-notification.show { top: 30px; opacity: 1; }
    .toast-notification.info { background-color: var(--info); color: var(--ink); }

    /* --- Loan Calculator Styles --- */
    .calculator-form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    @media (min-width: 768px) {
        .calculator-form-group {
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }
        .calculator-form-group > label {
            flex: 0 0 30%;
        }
    }
    .calculator-input, .calculator-select {
        background-color: var(--bg);
        border: 1px solid var(--border);
        color: var(--ink);
        border-radius: 0.5rem;
        padding: 0.75rem;
        width: 100%;
    }
     .calculator-input:read-only {
        background-color: #374151;
        cursor: not-allowed;
        opacity: 0.7;
    }
     [data-theme="dark"] .calculator-input:read-only {
         color: var(--muted);
     }


    /* Dark mode button overrides */
    [data-theme="dark"] .btn-secondary {
        background-color: var(--border);
        border-color: var(--border);
        color: var(--ink);
    }

    [data-theme="dark"] .btn-secondary:hover {
        filter: brightness(1.2);
    }
     [data-theme="dark"] #pos-address {
        color: var(--ink);
    }
    [data-theme="dark"] .form-check-label {
        color: var(--muted);
    }

    [data-theme="dark"] .btn-success, [data-theme="dark"] .btn-primary {
        background-color: #16a34a;
        border-color: #16a34a;
        color: #fff;
    }
     [data-theme="dark"] .btn-info {
        background-color: #0891b2;
        border-color: #0891b2;
        color: #fff;
    }
    [data-theme="dark"] .modal-content {
        background-color: var(--card);
        color: var(--ink);
    }
    [data-theme="dark"] .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }


    [data-theme="dark"] .btn-success:hover, [data-theme="dark"] .btn-primary:hover, [data-theme="dark"] .btn-info:hover {
        filter: brightness(1.2);
    }

    /* Dark mode tab overrides */
    [data-theme="dark"] .nav-tabs {
        border-bottom-color: var(--border);
    }

    [data-theme="dark"] .nav-tabs .nav-link {
        background: transparent;
        border-color: transparent transparent var(--border);
        color: var(--muted);
    }

    [data-theme="dark"] .nav-tabs .nav-link.active,
    [data-theme="dark"] .nav-tabs .nav-item.show .nav-link {
        background: var(--card);
        border-color: var(--border) var(--border) var(--card);
        color: var(--ink);
    }

    [data-theme="dark"] .nav-tabs .nav-link:hover:not(.active) {
        border-color: transparent transparent var(--border);
        isolation: isolate;
        background: #ffffff10;
    }

    /* Dark mode table overrides */
    [data-theme="dark"] .table {
        --bs-table-bg: transparent;
        --bs-table-border-color: var(--border);
        --bs-table-color: var(--ink);
    }

    [data-theme="dark"] .table-bordered th,
    [data-theme="dark"] .table-bordered td {
        border-color: var(--border);
    }

    [data-theme="dark"] .table thead th {
        color: var(--muted);
        font-weight: 600;
        white-space: nowrap;
    }

    [data-theme="dark"] .table tbody tr:first-child td {
        border-top: none;
    }
    [data-theme="dark"] .table td, [data-theme="dark"] .table th {
        padding: 1rem 0.5rem;
    }
    .date-col {
        white-space: nowrap;
    }
  </style>
  
  <!-- Thư viện PDF.js và pdf-lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
  <!-- Main Editor View -->
  <div class="container py-4" id="root">
    <div class="app-card mx-auto" style="max-width:1100px">
      <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
        <h3 class="title mb-0">Bộ công cụ HDSAISON</h3>
        <div class="d-flex align-items-center gap-3">
          <label for="pdfFile" class="btn btn-secondary px-3" id="uploadPdfLabel">
              <i class="fa-solid fa-file-pdf"></i> Tải PDF Hợp đồng
          </label>
          <input type="file" id="pdfFile" accept=".pdf" class="d-none" multiple />
          <button id="addRow" class="btn btn-success px-3">+ Thêm hợp đồng</button>
        </div>
      </div>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="qr-tab" data-bs-toggle="tab" data-bs-target="#qr-tab-pane" type="button" role="tab" aria-controls="qr-tab-pane" aria-selected="true">Tạo mã QR và In File HĐ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pdk-cho-lon-tab" data-bs-toggle="tab" data-bs-target="#pdk-cho-lon-tab-pane" type="button" role="tab" aria-controls="pdk-cho-lon-tab-pane" aria-selected="false">PDK 0%</button>
        </li>
         <li class="nav-item" role="presentation">
          <button class="nav-link" id="calculator-tab" data-bs-toggle="tab" data-bs-target="#calculator-tab-pane" type="button" role="tab" aria-controls="calculator-tab-pane" aria-selected="false">Tính Khoản Vay (ED)</button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="qr-tab-pane" role="tabpanel" aria-labelledby="qr-tab" tabindex="0">
           <div class="soft-panel my-4">
                <label for="pos-select" class="hdr mb-2">Chọn POS</label>
                <select class="form-select" id="pos-select">
                    <option value="POS24414">POS24414</option>
                    <option value="POS13858">POS13858</option>
                </select>
                <p id="pos-address" class="small mt-2 mb-0"></p>
            </div>
          
          <div id="toast" class="toast-notification"></div>
    
          <div class="d-none d-md-flex align-items-center justify-content-between px-3 mb-2">
            <div class="d-flex align-items-center gap-2" style="flex-grow: 1;">
              <div class="hdr" style="flex: 1 1 230px;">Số hợp đồng</div>
              <div class="hdr" style="flex: 1 1 260px;">Họ tên</div>
              <div class="hdr" style="flex: 1 1 170px;">Số tiền (VND)</div>
            </div>
            <div style="width: 220px;"> <!-- Placeholder for alignment -->
            </div>
          </div>
    
          <div id="rows"></div>
        </div>
        <div class="tab-pane fade" id="pdk-cho-lon-tab-pane" role="tabpanel" aria-labelledby="pdk-cho-lon-tab" tabindex="0">
          <div class="soft-panel my-4">
             <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="mt-2 mb-2">Thông tin Phiếu Đăng Ký 0%</h5>
               <button id="export-pdk-pdf-btn" class="btn btn-sm btn-primary mb-3"><i class="fa-solid fa-file-pdf me-2"></i>Xem trước & In tất cả PDK</button>
            </div>
            
            <p class="text-muted small">Dữ liệu trong bảng này được tự động cập nhật khi bạn tải file hợp đồng ở tab "Tạo mã QR". Bạn có thể nhấn nút "Xem trước & In" để mở tất cả các file PDK trong tab mới.</p>
            <div class="table-responsive mt-3">
              <table class="table table-bordered" id="pdk-info-table">
                <thead>
                  <tr>
                    <th>STT</th>
                    <th>Số HĐ</th>
                    <th>Tên KH</th>
                    <th>SĐT</th>
                    <th>Sản phẩm</th>
                    <th>Giá bán</th>
                    <th>Trả trước</th>
                    <th>Tiền vay</th>
                    <th>Thời hạn</th>
                    <th>Xóa</th>
                  </tr>
                </thead>
                <tbody id="pdk-results-tbody">
                  <!-- Dữ liệu sẽ được chèn vào đây -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="tab-pane fade p-3" id="calculator-tab-pane" role="tabpanel" aria-labelledby="calculator-tab" tabindex="0">
             <div class="soft-panel my-4">
                <div class="calculator-form-group">
                    <label for="loan-program" class="hdr">Chương trình vay</label>
                    <select id="loan-program" class="form-select calculator-select">
                        <option value="0" selected>Lãi suất 0%</option>
                        <option value="0.005">Lãi suất 0.5%</option>
                        <option value="0.01">Lãi suất 1%</option>
                        <option value="regular">Lãi thường</option>
                    </select>
                </div>
                 <div class="calculator-form-group">
                    <label for="product-price" class="hdr">Giá Sản Phẩm</label>
                    <div class="input-group">
                        <input type="text" inputmode="numeric" id="product-price" placeholder="Nhập giá sản phẩm" class="form-control calculator-input">
                        <button id="clear-ed" type="button" class="btn btn-danger">Xoá</button>
                    </div>
                </div>
                 <div class="calculator-form-group">
                    <label for="down-payment-percentage" class="hdr">Trả trước</label>
                     <div class="input-group">
                        <input type="text" inputmode="numeric" id="down-payment-percentage" placeholder="%" class="form-control calculator-input text-center" style="flex: 0 0 70px;">
                        <input type="text" inputmode="numeric" id="down-payment" placeholder="Hoặc nhập số tiền" class="form-control calculator-input">
                    </div>
                </div>
                 <div class="calculator-form-group">
                    <label for="loan-amount" class="hdr">Số tiền vay</label>
                    <input type="text" id="loan-amount" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                <div class="calculator-form-group">
                    <label for="loan-term" class="hdr">Số tháng</label>
                    <select id="loan-term" class="form-select calculator-select">
                        <option value="6" selected>6 tháng</option>
                        <option value="7">7 tháng</option>
                        <option value="9">9 tháng</option>
                        <option value="12">12 tháng</option>
                        <option value="15">15 tháng</option>
                        <option value="24">24 tháng</option>
                    </select>
                </div>
                 <div class="calculator-form-group">
                     <div class="w-full d-flex justify-content-md-end">
                         <div class="form-check">
                            <input id="include-insurance" type="checkbox" checked class="form-check-input">
                            <label for="include-insurance" class="form-check-label text-muted">Bao gồm bảo hiểm khoản vay</label>
                        </div>
                     </div>
                </div>
                 <div class="calculator-form-group">
                    <label for="monthly-difference" class="hdr">Phí chênh lệch (tháng)</label>
                    <input type="text" id="monthly-difference" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                 <div class="calculator-form-group">
                    <label for="total-price-with-fees" class="hdr">Tổng tiền gồm phí</label>
                    <input type="text" id="total-price-with-fees" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                <div class="calculator-form-group">
                    <label for="total-difference" class="hdr">Tổng tiền chênh lệch</label>
                    <input type="text" id="total-difference" readonly placeholder="Tự động tính" class="form-control calculator-input">
                </div>
                 <div class="calculator-form-group">
                    <label for="monthly-installment" class="hdr">Số tiền góp mỗi tháng</label>
                    <input type="text" id="monthly-installment" readonly placeholder="Tự động tính" class="form-control calculator-input fw-bold" style="color: var(--info); font-size: 1.2rem;">
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared Link Viewer -->
  <div class="container py-4" id="viewer" style="display: none;">
    <div class="app-card mx-auto" style="max-width: 520px; text-align: center;">
        <h3 class="title mb-3">Mã QR Thanh Toán</h3>
        <img id="viewerImg" alt="VietQR Code" style="width: 100%; max-width: 400px; height: auto; border-radius: 16px; margin-bottom: 1.5rem; background: #fff; padding: 10px;"/>
        <div class="soft-panel" style="text-align: left;">
            <p class="mb-2"><strong>Số hợp đồng:</strong> <span id="viewerContract"></span></p>
            <p class="mb-2"><strong>Họ tên:</strong> <span id="viewerName"></span></p>
            <p class="mb-0"><strong>Số tiền:</strong> <span id="viewerAmount" style="font-weight: bold; color: var(--info);"></span></p>
        </div>
        <button id="viewerDownloadBtn" class="btn btn-success mt-4">
          <i class="fa-solid fa-download"></i> Tải xuống
        </button>
    </div>
  </div>

  <!-- Lightbox Structure -->
  <div id="lb" class="lightbox" aria-hidden="true">
    <div class="lightbox-inner">
      <img id="lbImg" alt="VietQR phóng to"/>
      <div class="lightbox-actions">
          <button type="button" class="btn-lightbox download-qr" title="Tải ảnh QR">
              <i class="fa-solid fa-download"></i> Tải xuống
          </button>
          <button type="button" class="btn-lightbox" id="shareBtn" title="Chia sẻ">
              <i class="fa-solid fa-share-nodes"></i> Chia sẻ
          </button>
          <button type="button" class="btn-lightbox close" id="lbClose" title="Đóng">
              <i class="fa-solid fa-xmark"></i> Đóng
          </button>
      </div>
    </div>
  </div>

  <template id="rowTemplate">
    <div class="row-item">
      <div class="row-line">
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Số hợp đồng</label>
            <input class="form-control contractInput" placeholder="VD: ED01234567"/>
            <div class="error-msg"></div>
        </div>
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Họ tên</label>
            <input class="form-control nameInput" placeholder="VD: Nguyễn Văn A (Không bắt buộc)"/>
            <div class="error-msg"></div>
        </div>
        <div class="field-wrapper">
            <label class="hdr d-md-none mb-1">Số tiền (VND)</label>
            <input class="form-control amountInput" inputmode="numeric" placeholder="VD: 1.000.000"/>
            <div class="error-msg"></div>
        </div>
        <div class="actions-group">
            <button class="btn btn-primary generateBtn">Tạo QR</button>
            <img class="qr-thumb" alt="QR preview" title="Click để phóng to"/>
            <button class="btn btn-success printFullBtn" disabled title="In & Tải xuống tất cả file (HĐ, QR, PDK 0%)"><i class="fa-solid fa-print"></i></button>
            <button class="btn btn-outline-danger deleteRowBtn" title="Xoá dòng"><i class="fa-solid fa-trash-can"></i></button>
        </div>
      </div>
    </div>
  </template>
  
  <footer id="footer" class="text-center py-4">
    <p class="mb-0" style="font-size: 0.8rem; color: var(--muted);">Phát triển bởi Huỳnh Hải Đăng</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- Elements ---
    const pdfUpload = document.getElementById('pdfFile');
    const uploadPdfLabel = document.getElementById('uploadPdfLabel');
    const { PDFDocument, rgb } = PDFLib;
    const rowsEl = document.getElementById("rows");
    const addRowEl = document.getElementById("addRow");
    const tpl = document.getElementById("rowTemplate");
    const lb = document.getElementById("lb");
    const lbImg = document.getElementById("lbImg");
    const lbClose = document.getElementById("lbClose");
    const shareBtn = document.getElementById("shareBtn");
    const downloadQrBtn = lb.querySelector(".download-qr");
    const contractDataStore = new Map();

    const POS_INFO = {
        "POS24414": {
            address: "Số 5 Lý Thường Kiệt, KP. Thắng Lợi 1, P. Dĩ An, TP. Dĩ An, Bình Dương",
            templateUrl: 'https://rawcdn.githack.com/shikinora2/VietQR-HDSAISON/e77ada21e72f381e5d8aaa2aecc7b9851fece42d/PDK0IR%20-%20DMCL%20(2).pdf'
        },
        "POS13858": {
            address: "5A/2, Đường DT743, KP.1B, P. An Phú, Thuận An, Bình Dương",
            templateUrl: 'https://rawcdn.githack.com/shikinora2/VietQR-HDSAISON/e77ada21e72f381e5d8aaa2aecc7b9851fece42d/PDK0IR%20-%20DMCL%2013858.pdf'
        }
    };
    const FONT_URL = 'https://rawcdn.githack.com/shikinora2/VietQR-HDSAISON/f0381eb2e75227df3ceeb4ff3e8979f11229af35/SVN-Times%20New%20Roman%20Bold.ttf';
    const POS_STORAGE_KEY = 'selectedPos';

    // --- Helper & Utility Functions ---
    function stripVietnamese(str) {
        return (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/gi, "d");
    }

    function digitsOnly(str) {
        return String(str || "").replace(/\D/g, "");
    }

    function formatThousandDots(numStr) {
        return digitsOnly(numStr).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
     function parseNumber(str) {
        if (!str) return 0;
        return Number(String(str).replace(/[^0-9]/g, '')) || 0;
    }


    // --- Event Listeners ---
    if (uploadPdfLabel) {
        uploadPdfLabel.addEventListener('click', (e) => {
            e.preventDefault();
            if (!uploadPdfLabel.classList.contains('disabled')) {
                pdfUpload.click();
            }
        });
    }
    if (pdfUpload) {
        pdfUpload.addEventListener('change', handlePdfUpload);
    }
     if (addRowEl) {
        addRowEl.addEventListener("click", () => addRow(true));
    }
    document.addEventListener('DOMContentLoaded', () => {
        handleSharedLink();
        document.getElementById('export-pdk-pdf-btn').addEventListener('click', exportAllPdfs);
        
        const posSelect = document.getElementById('pos-select');
        const posAddress = document.getElementById('pos-address');

        function updatePosAddress() {
            const selectedPos = posSelect.value;
            if (posAddress && POS_INFO[selectedPos]) {
                posAddress.textContent = POS_INFO[selectedPos].address;
            }
        }

        if (posSelect) {
            const savedPos = localStorage.getItem(POS_STORAGE_KEY);
            if (savedPos) {
                posSelect.value = savedPos;
            }
            
            posSelect.addEventListener('change', () => {
                updatePosAddress();
                localStorage.setItem(POS_STORAGE_KEY, posSelect.value);
            });
            updatePosAddress(); // Initial call
        }
        
        // Loan Calculator ED Listeners
        const loanProgramSelect = document.getElementById('loan-program');
        const productPriceInput = document.getElementById('product-price');
        const downPaymentPercentageInput = document.getElementById('down-payment-percentage');
        const downPaymentInput = document.getElementById('down-payment');
        const loanTermSelect = document.getElementById('loan-term');
        const includeInsuranceCheckbox = document.getElementById('include-insurance');
        const clearEdBtn = document.getElementById('clear-ed');

        [loanProgramSelect, loanTermSelect, includeInsuranceCheckbox].forEach(el => el.addEventListener('change', calculateLoanEd));
        clearEdBtn.addEventListener('click', resetEdForm);
        productPriceInput.addEventListener('input', formatCurrencyOnLoanInput);
        downPaymentInput.addEventListener('input', (e) => {
            downPaymentPercentageInput.value = '';
            formatCurrencyOnLoanInput(e);
        });
        downPaymentPercentageInput.addEventListener('input', () => {
            const productPrice = parseNumber(productPriceInput.value);
            downPaymentPercentageInput.value = downPaymentPercentageInput.value.replace(/[^0-9]/g, '');
            const percentage = parseFloat(downPaymentPercentageInput.value);
            if (productPrice > 0 && !isNaN(percentage) && percentage >= 0 && percentage <= 100) {
                const downPaymentAmount = productPrice * (percentage / 100);
                downPaymentInput.value = downPaymentAmount.toLocaleString('vi-VN');
            } else {
                downPaymentInput.value = '';
            }
            calculateLoanEd();
        });
        calculateLoanEd();
    });
    
    // --- PDK 0% PDF Generation ---
    const PDK_COORDS = {
      "tenKH": { "x": 143.32, "y": 616.87 },
      "sdt": { "x": 143.32, "y": 603.04 },
      "sanPham": { "x": 117.31, "y": 465.25 },
      "giaBan": { "x": 112.88, "y": 444.78 },
      "ngayGiaoDich": { "x": 140.00, "y": 425.97 },
      "tienVay": { "x": 122.84, "y": 385.57 },
      "traTruoc": { "x": 145.53, "y": 366.20 },
      "thoiHan": { "x": 147.19, "y": 345.73 },
      "shd": { "x": 146.08, "y": 325.81 }
    };
    
    function formatCurrency(numStr) {
        if (typeof numStr === 'number') numStr = String(numStr);
        if (!numStr || isNaN(Number(digitsOnly(numStr)))) return "0 VNĐ";
        return formatThousandDots(numStr) + ' VNĐ';
    }
    
    async function generatePdkPdfBytes(pdkData, templateBytes, fontBytes) {
        const pdfDoc = await PDFDocument.load(templateBytes);
        pdfDoc.registerFontkit(fontkit);
        const font = await pdfDoc.embedFont(fontBytes, { subset: true });
        const page = pdfDoc.getPages()[0];
        const FONT_SIZE = 13;
        const COLOR = rgb(0, 0, 0);
        const today = new Date().toLocaleDateString('vi-VN');
        
        for (const key in PDK_COORDS) {
            let text = (key === 'ngayGiaoDich') ? today : pdkData[key] || '';
            if (['giaBan', 'tienVay', 'traTruoc'].includes(key)) {
                text = formatCurrency(text);
            }
            page.drawText(text, { ...PDK_COORDS[key], font, size: FONT_SIZE, color: COLOR, maxWidth: 400 });
        }
        
        return await pdfDoc.save();
    }

    async function exportAllPdfs() {
        const tableBody = document.getElementById('pdk-results-tbody');
        const exportBtn = document.getElementById('export-pdk-pdf-btn');
        const selectedPos = document.getElementById('pos-select').value;
        const pdfTemplateUrl = POS_INFO[selectedPos].templateUrl;

        if (tableBody.rows.length === 0) {
            showToast('Không có dữ liệu để xuất file PDF.');
            return;
        }

        const originalBtnHTML = exportBtn.innerHTML;
        exportBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...`;
        exportBtn.disabled = true;

        try {
            showToast('Đang tải tài nguyên cần thiết...', 'info');
            const [templateResponse, fontResponse] = await Promise.all([
                fetch(pdfTemplateUrl),
                fetch(FONT_URL)
            ]);

            if (!templateResponse.ok) throw new Error('Không thể tải file PDF mẫu.');
            if (!fontResponse.ok) throw new Error('Không thể tải file font.');

            const [templateBytes, fontBytes] = await Promise.all([
                templateResponse.arrayBuffer(),
                fontResponse.arrayBuffer()
            ]);
            
            showToast(`Bắt đầu xuất ${tableBody.rows.length} file PDF...`, 'info');

            for (const row of tableBody.rows) {
                 const rowData = {
                    shd: row.cells[1].textContent,
                    tenKH: row.cells[2].textContent,
                    sdt: row.cells[3].textContent,
                    sanPham: row.cells[4].textContent,
                    giaBan: row.cells[5].textContent,
                    traTruoc: row.cells[6].textContent,
                    tienVay: row.cells[7].textContent,
                    thoiHan: row.cells[8].textContent
                };
                
                const pdfBytes = await generatePdkPdfBytes(rowData, templateBytes, fontBytes);
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            }
            showToast(`Đã mở ${tableBody.rows.length} file PDF trong tab mới.`, 'info');

        } catch (error) {
            console.error('Lỗi khi xuất PDF:', error);
            showToast(error.message || 'Có lỗi xảy ra khi xuất PDF.');
        } finally {
            exportBtn.innerHTML = originalBtnHTML;
            exportBtn.disabled = false;
        }
    }

    // --- Core Functions ---
    async function handlePdfUpload(event) {
        const files = event.target.files;
        if (files.length === 0) return;

        const originalBtnHTML = uploadPdfLabel.innerHTML;
        uploadPdfLabel.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...`;
        uploadPdfLabel.classList.add('disabled');
        let successCount = 0;
        let isFirstFileInBatch = true; 

        for (const file of files) {
            if (file.type !== 'application/pdf') {
                showToast(`File "${file.name}" không phải là PDF và đã bị bỏ qua.`);
                continue;
            }
            try {
                const pdfBuffer = await file.arrayBuffer();
                
                let paymentPageNum = -1;
                let paymentPageText = '';
                let insurancePageNum = -1;
                let fullText = '';
                
                const pdf = await pdfjsLib.getDocument(new Uint8Array(pdfBuffer)).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                    
                    if (pageText.includes('HƯỚNG DẪN THANH TOÁN')) {
                        paymentPageNum = i; 
                        paymentPageText = pageText;
                    }
                    if (pageText.includes('BẢN YÊU CẦU BẢO HIỂM')) {
                        if (insurancePageNum === -1) insurancePageNum = i;
                    }
                }

                if (!paymentPageText) {
                    showToast(`Không tìm thấy trang Hướng Dẫn Thanh Toán trong file "${file.name}".`);
                    continue;
                }

                const allData = extractAllDataFromPdfText(fullText, paymentPageText);

                if (!allData.qrData || !allData.pdkData) {
                    showToast(`Không tìm thấy đủ thông tin trong file "${file.name}".`);
                    continue;
                }
                
                let rowEl;
                if (isFirstFileInBatch && rowsEl.children.length === 1) {
                    const firstRow = rowsEl.querySelector('.row-item');
                    const inputs = firstRow.querySelectorAll('.form-control');
                    const allEmpty = Array.from(inputs).every(i => i.value === '');
                    if (allEmpty) {
                        rowEl = firstRow;
                    }
                }
                if (!rowEl) {
                    rowEl = addRow();
                }

                allData.paymentPage = paymentPageNum;
                allData.insurancePage = insurancePageNum;
                contractDataStore.set(rowEl, { ...allData, pdfBuffer });

                // Populate QR Tab
                rowEl.querySelector(".contractInput").value = allData.qrData.contract;
                rowEl.querySelector(".nameInput").value = allData.qrData.name;
                rowEl.querySelector(".amountInput").value = formatThousandDots(allData.qrData.amount);
                rowEl.querySelector(".generateBtn").click();
                rowEl.querySelector(".printFullBtn").disabled = false;
                
                // Populate PDK Tab
                populatePdkRow(allData.pdkData);
                
                successCount++;
                isFirstFileInBatch = false;

            } catch (error) {
                console.error(`Lỗi xử lý file "${file.name}":`, error);
                showToast(`Không thể xử lý file "${file.name}".`);
            }
        }
        
        if (successCount > 0) showToast(`Đã xử lý thành công ${successCount} file PDF.`, 'info');
        
        uploadPdfLabel.innerHTML = originalBtnHTML;
        uploadPdfLabel.classList.remove('disabled');
        event.target.value = '';
    }
    
    function toTitleCase(str) {
        if (!str) return '';
        return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
    function extractAllDataFromPdfText(fullText, paymentPageText) {
        // QR Data Extraction
        const contractRegexQR = /Số Hợp Đồng:\s*([A-Z0-9]+)/;
        const nameRegexQR = /Họ tên:\s*(.*?)\s*Thông tin Khoản Vay:/;
        const amountRegexQR = /Khoản Thanh Toán Hàng Tháng:\s*([\d,.]+)\s*VNĐ/;

        const contractMatchQR = paymentPageText.match(contractRegexQR);
        const nameMatchQR = paymentPageText.match(nameRegexQR);
        const amountMatchQR = paymentPageText.match(amountRegexQR);
        
        const qrData = (contractMatchQR && nameMatchQR && amountMatchQR) ? {
            contract: contractMatchQR[1].trim(),
            name: nameMatchQR[1].trim(),
            amount: amountMatchQR[1].trim(),
        } : null;
        
        // PDK Data Extraction
        const pdkContractRegex = /Số:\s*([A-Z0-9]+)/;
        const pdkNameRegex = /1\.1\.\s*Họ tên:\s*(.*?)\s*1\.2\./;
        const pdkPhoneRegex = /1\.7\.\s*Điện thoại di động:\s*(\d+)/;
        const pdkProductRegex = /5\.9\.1\. Sản Phẩm Được Tài Trợ 1:\s*(.*?)(?:\s*Tổng Giá Bán|\s*5\.9\.2\.)/;
        const pdkPriceRegex = /2\.2\. Tổng giá trị Sản Phẩm Được Tài Trợ:\s*([0-9,.]+(?:\s*VNĐ)?)/;
        const pdkPrepaidRegex = /2\.3\. Khoản Tiền Mặt Trả Trước:\s*([0-9,.]+(?:\s*VNĐ)?)/;
        const pdkLoanRegex = /2\.4\. Số tiền đề nghị vay:\s*([0-9,.]+(?:\s*VNĐ)?)/;
        const pdkTermRegex = /2\.5\. Thời Hạn Vay:\s*(.*?)\s*3\./;
        
        const findValue = (text, regex) => {
            const match = text.match(regex);
            return match ? match[1].replace('VNĐ', '').trim() : null;
        };

        let tenKH = findValue(fullText, pdkNameRegex);
        if (tenKH) tenKH = toTitleCase(tenKH);

        const pdkData = {
            shd: findValue(fullText, pdkContractRegex),
            tenKH: tenKH,
            sdt: findValue(fullText, pdkPhoneRegex),
            sanPham: findValue(fullText, pdkProductRegex)?.split(',').map(item => item.trim().replace(/^\d+-/, '')).join(', '),
            giaBan: findValue(fullText, pdkPriceRegex),
            traTruoc: findValue(fullText, pdkPrepaidRegex),
            tienVay: findValue(fullText, pdkLoanRegex),
            thoiHan: findValue(fullText, pdkTermRegex)
        };
        
        const hasAllPdkData = Object.values(pdkData).every(val => val !== null);
        
        return {
            qrData,
            pdkData: hasAllPdkData ? pdkData : null
        };
    }
    
    function populatePdkRow(pdkData) {
        const tbody = document.getElementById('pdk-results-tbody');
        const row = tbody.insertRow();
        row.insertCell().textContent = tbody.rows.length;
        Object.values(pdkData).forEach(value => {
            row.insertCell().textContent = value;
        });
        
        const actionCell = row.insertCell();
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
        deleteBtn.onclick = () => {
            row.remove();
            updateStt('#pdk-results-tbody');
        };
        actionCell.appendChild(deleteBtn);
    }

    async function createAndPreviewSplitPdf(contractData, qrUrl, contractId) {
        const previewWindow = window.open("", "_blank");
        if (!previewWindow) {
            showToast("Trình duyệt đã chặn popup. Vui lòng cho phép popup.");
            return;
        }
        previewWindow.document.write('<!DOCTYPE html><html lang="vi"><head><title>Đang tách file...</title><style>body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-size:1.2rem;color:#333;}</style></head><body><p>⏳ Đang chuẩn bị các file PDF, vui lòng chờ trong giây lát...</p></body></html>');

        try {
            const { pdfBuffer, paymentPage, insurancePage } = contractData;
            const originalPdfDoc = await PDFDocument.load(pdfBuffer);
            const totalPages = originalPdfDoc.getPageCount();

            // --- 1. Hợp đồng Tín dụng (Trang 1-4) ---
            const hopDongDoc = await PDFDocument.create();
            const hopDongPages = await hopDongDoc.copyPages(originalPdfDoc, [0, 1, 2, 3]);
            hopDongPages.forEach(page => hopDongDoc.addPage(page));
            const hopDongBytes = await hopDongDoc.save();
            const hopDongUrl = URL.createObjectURL(new Blob([hopDongBytes], { type: 'application/pdf' }));
            
            // --- 2. Hướng dẫn Thanh toán (1 trang + QR) ---
            const thanhToanDoc = await PDFDocument.create();
            const [thanhToanPage] = await thanhToanDoc.copyPages(originalPdfDoc, [paymentPage - 1]);
            thanhToanDoc.addPage(thanhToanPage);
            const qrImageBytes = await fetch(qrUrl).then(res => res.arrayBuffer());
            const qrImage = await thanhToanDoc.embedPng(qrImageBytes);
            const { width, height } = thanhToanPage.getSize();
            const qrDims = qrImage.scale(0.25);
            thanhToanPage.drawImage(qrImage, { x: width - qrDims.width - 30, y: height - qrDims.height - 25, width: qrDims.width, height: qrDims.height });
            const thanhToanBytes = await thanhToanDoc.save();
            const thanhToanUrl = URL.createObjectURL(new Blob([thanhToanBytes], { type: 'application/pdf' }));

            // --- 3. Yêu cầu Bảo hiểm (2 trang cuối) ---
            let baoHiemUrl = '';
            if (insurancePage > 0 && insurancePage + 1 <= totalPages) {
                const baoHiemDoc = await PDFDocument.create();
                const baoHiemPages = await baoHiemDoc.copyPages(originalPdfDoc, [insurancePage - 1, insurancePage]);
                baoHiemPages.forEach(page => baoHiemDoc.addPage(page));
                const baoHiemBytes = await baoHiemDoc.save();
                baoHiemUrl = URL.createObjectURL(new Blob([baoHiemBytes], { type: 'application/pdf' }));
            }
            
            // --- 4. Generate PDK 0% PDF ---
            const selectedPos = document.getElementById('pos-select').value;
            const pdfTemplateUrl = POS_INFO[selectedPos].templateUrl;

            const [templateResponse, fontResponse] = await Promise.all([
                fetch(pdfTemplateUrl),
                fetch(FONT_URL)
            ]);
            const [templateBytes, fontBytes] = await Promise.all([
                templateResponse.arrayBuffer(),
                fontResponse.arrayBuffer()
            ]);
            const pdkBytes = await generatePdkPdfBytes(contractData.pdkData, templateBytes, fontBytes);
            const pdkUrl = URL.createObjectURL(new Blob([pdkBytes], { type: 'application/pdf' }));
            
            const previewHtml = `
                <!DOCTYPE html>
                <html lang="vi">
                <head>
                    <meta charset="UTF-8">
                    <title>Tải xuống & In Hợp đồng ${contractId}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
                    <style>
                        body { background-color: #0f172a; color: #e5e7eb; font-family: system-ui, sans-serif; }
                        .container { max-width: 700px; }
                        .card { background-color: #111827; border: 1px solid #263143; }
                        .card h3 { color: #ffffff; }
                        .card .contract-id { color: #e5e7eb; }
                        .list-group-item {
                            background-color: #1f2937 !important;
                            color: #e5e7eb !important;
                            border-color: #374151 !important;
                        }
                        .file-link {
                            color: #e5e7eb;
                            text-decoration: none;
                            flex-grow: 1;
                            transition: color .2s;
                        }
                        .file-link:hover {
                            color: #93c5fd;
                        }
                        .action-btn {
                            color: #9ca3af;
                            text-decoration: none;
                            font-size: 1.1rem;
                            transition: color .2s;
                        }
                        .action-btn:hover {
                            color: #e5e7eb;
                        }
                    </style>
                </head>
                <body>
                    <div class="container py-5">
                        <div class="card p-4 rounded-4">
                            <h3 class="mb-4 text-center">Tải xuống & In Hợp đồng</h3>
                            <p class="text-center contract-id mb-4">Số hợp đồng: <strong>${contractId}</strong></p>
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="${hopDongUrl}" target="_blank" class="file-link">
                                        <span><i class="fa-solid fa-file-contract fa-fw me-3"></i>Hợp Đồng Tín Dụng</span>
                                    </a>
                                    <div class="actions">
                                        <a href="${hopDongUrl}" target="_blank" class="action-btn me-3" title="In"><i class="fa-solid fa-print"></i></a>
                                        <a href="${hopDongUrl}" download="HopDongTinDung_${contractId}.pdf" class="action-btn" title="Tải về"><i class="fa-solid fa-download"></i></a>
                                    </div>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="${thanhToanUrl}" target="_blank" class="file-link">
                                       <span><i class="fa-solid fa-qrcode fa-fw me-3"></i>Hướng Dẫn Thanh Toán (có QR)</span>
                                    </a>
                                     <div class="actions">
                                        <a href="${thanhToanUrl}" target="_blank" class="action-btn me-3" title="In"><i class="fa-solid fa-print"></i></a>
                                        <a href="${thanhToanUrl}" download="HuongDanThanhToan_${contractId}.pdf" class="action-btn" title="Tải về"><i class="fa-solid fa-download"></i></a>
                                    </div>
                                </div>
                                ${baoHiemUrl ? `
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                     <a href="${baoHiemUrl}" target="_blank" class="file-link">
                                        <span><i class="fa-solid fa-shield-halved fa-fw me-3"></i>Bản Yêu Cầu Bảo Hiểm</span>
                                    </a>
                                    <div class="actions">
                                        <a href="${baoHiemUrl}" target="_blank" class="action-btn me-3" title="In"><i class="fa-solid fa-print"></i></a>
                                        <a href="${baoHiemUrl}" download="YeuCauBaoHiem_${contractId}.pdf" class="action-btn" title="Tải về"><i class="fa-solid fa-download"></i></a>
                                    </div>
                                </div>` : ''}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                     <a href="${pdkUrl}" target="_blank" class="file-link">
                                        <span><i class="fa-solid fa-file-pen fa-fw me-3"></i>Phiếu Đăng Ký 0%</span>
                                    </a>
                                    <div class="actions">
                                        <a href="${pdkUrl}" target="_blank" class="action-btn me-3" title="In"><i class="fa-solid fa-print"></i></a>
                                        <a href="${pdkUrl}" download="PDK_0%_${contractId}.pdf" class="action-btn" title="Tải về"><i class="fa-solid fa-download"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            previewWindow.document.open();
            previewWindow.document.write(previewHtml);
            previewWindow.document.close();

        } catch (error) {
            console.error("Lỗi khi tách file PDF:", error);
            previewWindow.document.body.innerHTML = `<p>❌ Đã xảy ra lỗi khi tách file PDF. Vui lòng thử lại.</p>`;
            showToast("Lỗi khi tách file PDF.");
        }
    }

    function addRow(isManual = false) {
        const node = tpl.content.cloneNode(true);
        const el = node.querySelector(".row-item");
        const inputContract = el.querySelector(".contractInput");
        const inputName = el.querySelector(".nameInput");
        const inputAmount = el.querySelector(".amountInput");
        const btnGen = el.querySelector(".generateBtn");
        const btnPrintFull = el.querySelector(".printFullBtn");
        const btnDelRow = el.querySelector(".deleteRowBtn");
        const img = el.querySelector(".qr-thumb");
        const errorMessages = {
            contract: el.querySelector(".contractInput + .error-msg"),
            amount: el.querySelector(".amountInput + .error-msg"),
        };

        [inputContract, inputName, inputAmount].forEach(input => {
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    btnGen.click();
                }
            });
        });

        inputAmount.addEventListener("input", () => {
            const value = inputAmount.value;
            const caretPos = inputAmount.selectionStart;
            const originalLength = value.length;

            const formattedValue = formatThousandDots(value);
            inputAmount.value = formattedValue;

            const newLength = formattedValue.length;
            if (caretPos !== null) {
                const newCaretPos = caretPos + (newLength - originalLength);
                inputAmount.setSelectionRange(newCaretPos, newCaretPos);
            }
        });

        function validate() {
            let valid = true;
            errorMessages.contract.style.display = "none";
            errorMessages.amount.style.display = "none";
            inputContract.classList.remove("is-invalid");
            inputAmount.classList.remove("is-invalid");

            if (!inputContract.value.trim()) {
                errorMessages.contract.textContent = "Số hợp đồng không được để trống.";
                errorMessages.contract.style.display = "block";
                inputContract.classList.add("is-invalid");
                valid = false;
            }
            if (!digitsOnly(inputAmount.value)) {
                errorMessages.amount.textContent = "Số tiền không được để trống.";
                errorMessages.amount.style.display = "block";
                inputAmount.classList.add("is-invalid");
                valid = false;
            }
            return valid;
        }

        btnGen.addEventListener("click", () => {
            if (!validate()) return;
            const data = { contract: inputContract.value, name: inputName.value, amount: inputAmount.value };
            const qrUrl = buildQRUrl(data);
            img.src = qrUrl;
            img.style.display = "block";
        });
        
        btnPrintFull.addEventListener("click", async () => {
            if (!contractDataStore.has(el)) {
                 showToast("Chức năng này chỉ dành cho các hợp đồng được tải lên từ file PDF.");
                return;
            }
            const contractData = contractDataStore.get(el);
            const qrUrl = buildQRUrl(contractData.qrData, "compact.png");
            const contractId = contractData.qrData.contract;
            await createAndPreviewSplitPdf(contractData, qrUrl, contractId);
        });

        btnDelRow.addEventListener("click", () => {
            if (contractDataStore.has(el)) {
                 const contractIdToDelete = contractDataStore.get(el).pdkData.shd;
                 const pdkTableBody = document.getElementById('pdk-results-tbody');
                 Array.from(pdkTableBody.rows).forEach(row => {
                     if (row.cells[1].textContent === contractIdToDelete) {
                         row.remove();
                     }
                 });
                 updateStt('#pdk-results-tbody');
                contractDataStore.delete(el);
            }
            el.style.transition = 'opacity 0.3s, transform 0.3s';
            el.style.opacity = '0';
            el.style.transform = 'scale(0.95)';
            setTimeout(() => el.remove(), 300);
        });

        img.addEventListener("click", () => {
            if (!img.src) return;
            lbImg.src = img.src;
            lb.classList.add("show");
            lb.setAttribute("aria-hidden", "false");
            downloadQrBtn.href = img.src;
            
            const data = { contract: inputContract.value, name: inputName.value, amount: inputAmount.value };
            const shareUrl = buildShareLink(data);
            shareBtn.onclick = () => copyToClipboard(shareUrl, "Đã sao chép link chia sẻ!");
        });

        rowsEl.appendChild(node);
        // Only focus if it's a manual add, not from PDF upload
        if (isManual) {
           inputContract.focus();
        }
        return el;
    }

    async function getPdfText(pdfBuffer) {
        const typedarray = new Uint8Array(pdfBuffer);
        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            fullText += textContent.items.map(item => item.str).join(' ');
        }
        return fullText;
    }
    
    function updateStt(tbodySelector) {
        const rows = document.querySelectorAll(`${tbodySelector} tr`);
        rows.forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    // --- Helper & Utility Functions ---
    function buildQRUrl({ contract, name, amount }, template = "print.png") {
        const addInfo = `${contract} ${stripVietnamese(name)}`.trim().toUpperCase();
        const qs = new URLSearchParams({
            accountName: "HD SAISON",
            amount: digitsOnly(amount),
            addInfo: addInfo,
            template: template,
        });
        return `https://img.vietqr.io/image/970437-002704070014601-${template}?${qs.toString()}`;
    }
    
    function closeLb() {
        lb.classList.remove("show");
        lb.setAttribute("aria-hidden", "true");
        lbImg.src = "";
    }
    lb.addEventListener("click", (e) => e.target === lb && closeLb());
    lbClose.addEventListener("click", closeLb);
    document.addEventListener("keydown", (e) => e.key === "Escape" && closeLb());

    function buildShareLink(data) {
        const url = new URL(window.location.href.split('?')[0]);
        url.searchParams.set('c', data.contract);
        url.searchParams.set('n', data.name);
        url.searchParams.set('a', data.amount);
        return url.toString();
    }

    function handleSharedLink() {
        const params = new URLSearchParams(window.location.search);
        const contract = params.get('c'), name = params.get('n'), amount = params.get('a');

        if (contract && amount) {
            const formattedAmount = formatThousandDots(amount);
            const qrUrl = buildQRUrl({ contract, name, amount });

            document.getElementById('root').style.display = 'none';
            document.getElementById('footer').style.display = 'none';
            document.getElementById('viewer').style.display = 'block';

            document.getElementById('viewerImg').src = qrUrl;
            document.getElementById('viewerContract').textContent = contract;
            document.getElementById('viewerName').textContent = name || 'N/A';
            document.getElementById('viewerAmount').textContent = `${formattedAmount} VND`;
            document.getElementById('viewerDownloadBtn').onclick = () => {
                const a = document.createElement('a');
                a.href = qrUrl;
                a.download = `QR_${contract}.png`;
                a.click();
            };
        } else {
            if (rowsEl && rowsEl.children.length === 0) addRow(true);
        }
    }
    
    function showToast(message, type = 'error') {
        const toastEl = document.createElement('div');
        toastEl.className = `toast-notification`;
        if (type === 'info') toastEl.classList.add('info');

        toastEl.textContent = message;
        document.body.appendChild(toastEl);
        setTimeout(() => {
            toastEl.classList.add('show');
            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => toastEl.remove(), 300);
            }, 3500);
        }, 10);
    }
    
    function copyToClipboard(text, message) {
        navigator.clipboard.writeText(text)
            .then(() => showToast(message, 'info'))
            .catch(err => showToast('Lỗi khi sao chép.'));
    }
    
    // --- Loan Calculator ED ---
    function calculateLoanEd() {
        const loanProgramSelect = document.getElementById('loan-program');
        const productPriceInput = document.getElementById('product-price');
        const downPaymentInput = document.getElementById('down-payment');
        const loanAmountInput = document.getElementById('loan-amount');
        const loanTermSelect = document.getElementById('loan-term');
        const includeInsuranceCheckbox = document.getElementById('include-insurance');
        const monthlyDifferenceInput = document.getElementById('monthly-difference');
        const totalPriceWithFeesInput = document.getElementById('total-price-with-fees');
        const totalDifferenceInput = document.getElementById('total-difference');
        const monthlyInstallmentInput = document.getElementById('monthly-installment');

        const productPrice = parseNumber(productPriceInput.value);
        const downPayment = parseNumber(downPaymentInput.value);
        let loanAmount = 0;

        if (productPrice > 0 && productPrice >= downPayment) {
            loanAmount = productPrice - downPayment;
            loanAmountInput.value = formatCurrency(loanAmount);
        } else {
            loanAmountInput.value = "";
        }

        const loanTerm = parseInt(loanTermSelect.value, 10);
        const loanProgramValue = loanProgramSelect.value;

        if (loanAmount > 0 && loanTerm > 0) {
            let totalInsurance = 0;
            let monthlyInsurance = 0;
            if (includeInsuranceCheckbox.checked) {
                totalInsurance = loanAmount * 0.05;
                monthlyInsurance = totalInsurance / loanTerm;
            } 

            let monthlyInstallment = 0;
            let totalDifference = 0;
            let totalPriceWithFees = 0;

            if (loanProgramValue === 'regular') {
                const coefficients = { '7': 0.175, '9': 0.1393, '12': 0.11135, '15': 0.0947 };
                const coefficient = coefficients[loanTerm];
                if (coefficient) {
                    const basePaymentWithInsurance = loanAmount * coefficient;
                    if (includeInsuranceCheckbox.checked) {
                        monthlyInstallment = basePaymentWithInsurance + 13000;
                    } else {
                        const basePaymentWithoutInsurance = basePaymentWithInsurance - monthlyInsurance;
                        monthlyInstallment = basePaymentWithoutInsurance + 13000;
                    }
                    const totalPayment = monthlyInstallment * loanTerm;
                    totalDifference = totalPayment - loanAmount;
                    totalPriceWithFees = productPrice + totalDifference;
                } else {
                    monthlyInstallment = 0; // Mark as not applicable
                }
            } else {
                const interestRatePerMonthFromSelect = parseFloat(loanProgramValue);
                let totalInterest = 0;
                if (interestRatePerMonthFromSelect === 0.005 && loanTerm === 6) {
                    totalInterest = loanAmount * 0.0322;
                } else {
                    totalInterest = loanAmount * interestRatePerMonthFromSelect * loanTerm;
                }
                const totalCollectionFee = 12000 * loanTerm;
                const totalPayment = loanAmount + totalInsurance + totalInterest + totalCollectionFee;
                monthlyInstallment = totalPayment / loanTerm;
                totalDifference = totalInsurance + totalInterest + totalCollectionFee;
                totalPriceWithFees = productPrice + totalDifference;
            }
            
            const formatMonthly = (num) => num > 0 ? (Math.ceil(num / 1000) * 1000).toLocaleString('vi-VN') + ' VNĐ' : "Không áp dụng";
            
            let monthlyDifference = 0;
            if (totalDifference > 0 && loanTerm > 0) {
                monthlyDifference = totalDifference / loanTerm;
            }
            const formatMonthlyDifference = (num) => {
                if (num > 0) {
                    const rounded = Math.round(num / 100) * 100;
                    return rounded.toLocaleString('vi-VN') + ' VNĐ';
                }
                return "0 VNĐ";
            };

            monthlyInstallmentInput.value = formatMonthly(monthlyInstallment);
            totalDifferenceInput.value = formatCurrency(totalDifference);
            totalPriceWithFeesInput.value = formatCurrency(totalPriceWithFees);
            monthlyDifferenceInput.value = formatMonthlyDifference(monthlyDifference);

        } else {
            monthlyDifferenceInput.value = "";
            totalDifferenceInput.value = "";
            totalPriceWithFeesInput.value = "";
            monthlyInstallmentInput.value = "";
        }
    }
    
    function formatCurrencyOnLoanInput(event) {
        const input = event.target;
        const originalValue = input.value;
        const originalCursor = input.selectionStart;
        const numericValue = parseNumber(originalValue);
        const formattedValue = numericValue > 0 ? numericValue.toLocaleString('vi-VN') : '';
        input.value = formattedValue;
        const newCursor = originalCursor + (formattedValue.length - originalValue.length);
        input.setSelectionRange(newCursor, newCursor);
        calculateLoanEd();
    }

    function resetEdForm() {
        const productPriceInput = document.getElementById('product-price');
        const downPaymentPercentageInput = document.getElementById('down-payment-percentage');
        const downPaymentInput = document.getElementById('down-payment');
        const loanTermSelect = document.getElementById('loan-term');
        const includeInsuranceCheckbox = document.getElementById('include-insurance');
        
        productPriceInput.value = '';
        downPaymentPercentageInput.value = '';
        downPaymentInput.value = '';
        loanTermSelect.value = '6';
        includeInsuranceCheckbox.checked = true;
        productPriceInput.focus();
        calculateLoanEd();
    }

  </script>
</body>
</html>

